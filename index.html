<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <meta name="description" content="Join Jaycee and Emily for their Myrtle Beach wedding celebration. Interactive features, games, photos and more!">
    <meta name="theme-color" media="(prefers-color-scheme: light)" content="#047857">
    <meta name="theme-color" media="(prefers-color-scheme: dark)" content="#1c1917">
    <title>Jaycee & Emily's Dream Wedding 💕</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>tailwind.config = { darkMode: 'class' }</script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Dancing+Script:wght@400;700&family=Playfair+Display:wght@400;700&family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="manifest" href="manifest.json">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root {
            --primary: #047857;
            --primary-light: #10b981;
            --accent: #ec4899;
            --gold: #f59e0b;
        }
        
        body {
            font-family: 'Inter', sans-serif;
            background: linear-gradient(135deg, #FEFBF6 0%, #FFF5E6 100%);
            color: #2b2726;
            overflow-x: hidden;
        }
        
        body.dark-mode {
            background: linear-gradient(135deg, #1c1917 0%, #292524 100%);
            color: #d6d3d1;
        }
        
        h1, h2, h3, .font-display {
            font-family: 'Playfair Display', serif;
        }
        
        .font-script {
            font-family: 'Dancing Script', cursive;
        }
        
        /* Animations */
        @keyframes float {
            0%, 100% { transform: translateY(0) rotate(0deg); }
            50% { transform: translateY(-20px) rotate(5deg); }
        }
        
        @keyframes pulse-glow {
            0%, 100% { box-shadow: 0 0 20px rgba(236, 72, 153, 0.5); }
            50% { box-shadow: 0 0 40px rgba(236, 72, 153, 0.8); }
        }
        
        @keyframes shimmer {
            0% { background-position: -1000px 0; }
            100% { background-position: 1000px 0; }
        }
        
        @keyframes heartbeat {
            0%, 100% { transform: scale(1); }
            10%, 30% { transform: scale(1.1); }
            20% { transform: scale(1.05); }
        }
        
        @keyframes confetti-fall {
            to {
                transform: translateY(100vh) rotate(360deg);
                opacity: 0;
            }
        }
        
        @keyframes slide-up {
            from { transform: translateY(100px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }
        
        @keyframes fade-in-scale {
            from { transform: scale(0.8); opacity: 0; }
            to { transform: scale(1); opacity: 1; }
        }
        
        .animate-float {
            animation: float 6s ease-in-out infinite;
        }
        
        .animate-heartbeat {
            animation: heartbeat 1.5s ease-in-out infinite;
        }
        
        .shimmer {
            background: linear-gradient(90deg, transparent 0%, rgba(255,255,255,0.3) 50%, transparent 100%);
            background-size: 1000px 100%;
            animation: shimmer 2s infinite;
        }
        
        .glass-morphism {
            background: rgba(255, 255, 255, 0.7);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.3);
        }
        
        .dark-mode .glass-morphism {
            background: rgba(0, 0, 0, 0.5);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        /* Page transitions */
        .page {
            display: none;
            animation: slide-up 0.5s ease-out;
        }
        
        .page.active {
            display: block;
        }
        
        /* Enhanced nav */
        .nav-icon {
            position: relative;
            transition: all 0.3s ease;
        }
        
        .nav-icon::after {
            content: '';
            position: absolute;
            bottom: -2px;
            left: 50%;
            width: 0;
            height: 2px;
            background: var(--primary);
            transition: all 0.3s ease;
            transform: translateX(-50%);
        }
        
        .nav-icon.active::after {
            width: 30px;
        }
        
        .nav-icon.active {
            color: var(--primary);
            transform: translateY(-2px);
        }
        
        /* Countdown styles */
        .countdown-digit {
            background: linear-gradient(135deg, var(--primary) 0%, var(--accent) 100%);
            position: relative;
            overflow: hidden;
            animation: fade-in-scale 0.5s ease-out;
            color: white;
            font-size: 2rem;
            font-weight: bold;
            padding: 1rem;
            border-radius: 0.5rem;
            min-width: 80px;
            text-align: center;
        }
        
        .countdown-digit::before {
            content: '';
            position: absolute;
            top: -50%;
            left: -50%;
            width: 200%;
            height: 200%;
            background: linear-gradient(45deg, transparent 30%, rgba(255,255,255,0.2) 50%, transparent 70%);
            transform: rotate(45deg);
            animation: shimmer 3s infinite;
        }
        
        /* Love meter enhanced */
        .love-meter {
            background: linear-gradient(90deg, #ec4899 0%, #f97316 33%, #eab308 66%, #10b981 100%);
            height: 30px;
            border-radius: 15px;
            position: relative;
            overflow: hidden;
            box-shadow: 0 4px 20px rgba(236, 72, 153, 0.3);
        }
        
        .love-meter-fill {
            position: absolute;
            height: 100%;
            background: rgba(255, 255, 255, 0.3);
            animation: pulse 2s ease-in-out infinite;
        }
        
        .love-meter::after {
            content: '💕';
            position: absolute;
            right: 10px;
            top: 50%;
            transform: translateY(-50%);
            font-size: 20px;
            animation: heartbeat 1.5s ease-in-out infinite;
        }
        
        /* Card styles */
        .wedding-card {
            background: white;
            border-radius: 1rem;
            padding: 1.5rem;
            box-shadow: 0 10px 30px -10px rgba(0, 0, 0, 0.1);
            border: 1px solid rgba(0, 0, 0, 0.05);
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }
        
        .wedding-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 3px;
            background: linear-gradient(90deg, var(--primary) 0%, var(--accent) 100%);
            transform: scaleX(0);
            transition: transform 0.3s ease;
        }
        
        .wedding-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 20px 40px -10px rgba(0, 0, 0, 0.15);
        }
        
        .wedding-card:hover::before {
            transform: scaleX(1);
        }
        
        .dark-mode .wedding-card {
            background: rgba(31, 41, 55, 0.8);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        /* Game card enhanced */
        .game-card {
            cursor: pointer;
            background: linear-gradient(135deg, #ffffff 0%, #f0fdf4 100%);
            position: relative;
            overflow: hidden;
        }
        
        .game-card::after {
            content: '';
            position: absolute;
            top: -50%;
            right: -50%;
            width: 100%;
            height: 100%;
            background: radial-gradient(circle, rgba(16, 185, 129, 0.1) 0%, transparent 70%);
            transform: scale(0);
            transition: transform 0.5s ease;
        }
        
        .game-card:hover::after {
            transform: scale(3);
        }
        
        .dark-mode .game-card {
            background: linear-gradient(135deg, rgba(31, 41, 55, 0.9) 0%, rgba(16, 185, 129, 0.1) 100%);
        }
        
        /* Button styles */
        .btn-primary {
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-light) 100%);
            color: white;
            font-weight: 600;
            padding: 0.75rem 1.5rem;
            border-radius: 0.5rem;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }
        
        .btn-primary::before {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 0;
            height: 0;
            background: rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            transform: translate(-50%, -50%);
            transition: width 0.6s, height 0.6s;
        }
        
        .btn-primary:hover::before {
            width: 300px;
            height: 300px;
        }
        
        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px -5px rgba(4, 120, 87, 0.3);
        }
        
        /* Gemini button enhanced */
        .gemini-button {
            background: linear-gradient(135deg, #e879f9 0%, #f0abfc 100%);
            color: #701a75;
            border: 1px solid #e879f9;
            position: relative;
            overflow: hidden;
            transition: all 0.3s ease;
        }
        
        .gemini-button span:first-child {
            display: inline-block;
            animation: float 2s ease-in-out infinite;
        }
        
        .gemini-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px -5px rgba(232, 121, 249, 0.3);
        }
        
        /* Modal enhancements */
        .modal-backdrop {
            backdrop-filter: blur(5px);
            transition: all 0.3s ease;
        }
        
        .modal-content {
            animation: fade-in-scale 0.3s ease-out;
            max-height: 90vh;
            overflow-y: auto;
        }
        
        /* Photo grid enhanced */
        .photo-item {
            position: relative;
            overflow: hidden;
            border-radius: 0.75rem;
            cursor: pointer;
            aspect-ratio: 1;
        }
        
        .photo-item img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            transition: transform 0.3s ease;
        }
        
        .photo-item:hover img {
            transform: scale(1.1);
        }
        
        .photo-item .photo-overlay {
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            background: linear-gradient(to top, rgba(0,0,0,0.7) 0%, transparent 100%);
            color: white;
            padding: 1rem;
            transform: translateY(100%);
            transition: transform 0.3s ease;
        }
        
        .photo-item:hover .photo-overlay {
            transform: translateY(0);
        }
        
        /* Achievement badge */
        .achievement-badge {
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            background: linear-gradient(135deg, var(--gold) 0%, #fbbf24 100%);
            color: white;
            padding: 0.25rem 0.75rem;
            border-radius: 9999px;
            font-size: 0.875rem;
            font-weight: 600;
            box-shadow: 0 4px 10px -2px rgba(245, 158, 11, 0.3);
            animation: fade-in-scale 0.5s ease-out;
        }
        
        /* Loading spinner */
        .spinner {
            width: 40px;
            height: 40px;
            border: 3px solid rgba(0, 0, 0, 0.1);
            border-top-color: var(--primary);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        /* Confetti */
        .confetti {
            position: fixed;
            width: 10px;
            height: 10px;
            background: var(--accent);
            animation: confetti-fall 3s linear;
            z-index: 100;
        }
        
        /* Toast notification */
        .toast {
            position: fixed;
            bottom: 100px;
            left: 50%;
            transform: translateX(-50%) translateY(100px);
            background: rgba(0, 0, 0, 0.8);
            color: white;
            padding: 1rem 2rem;
            border-radius: 0.5rem;
            font-weight: 500;
            opacity: 0;
            transition: all 0.3s ease;
            z-index: 100;
        }
        
        .toast.show {
            transform: translateX(-50%) translateY(0);
            opacity: 1;
        }
        
        /* Love story timeline */
        .timeline-item {
            position: relative;
            padding-left: 3rem;
            padding-bottom: 2rem;
            border-left: 2px solid var(--primary);
        }
        
        .timeline-item::before {
            content: '';
            position: absolute;
            left: -8px;
            top: 0;
            width: 16px;
            height: 16px;
            background: var(--primary);
            border-radius: 50%;
            box-shadow: 0 0 0 4px rgba(4, 120, 87, 0.2);
        }
        
        .timeline-item:hover::before {
            animation: pulse 1s ease-in-out infinite;
        }
        
        /* Weather widget */
        .weather-widget {
            background: linear-gradient(135deg, #3b82f6 0%, #60a5fa 100%);
            color: white;
            padding: 1rem;
            border-radius: 1rem;
            position: relative;
            overflow: hidden;
        }
        
        .weather-widget::before {
            content: '☀️';
            position: absolute;
            top: -20px;
            right: -20px;
            font-size: 80px;
            opacity: 0.2;
            animation: float 10s ease-in-out infinite;
        }
        
        /* RSVP form styles */
        .rsvp-input {
            width: 100%;
            padding: 0.75rem 1rem;
            border: 2px solid #e5e7eb;
            border-radius: 0.5rem;
            transition: all 0.3s ease;
            font-size: 1rem;
        }
        
        .rsvp-input:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(4, 120, 87, 0.1);
        }
        
        /* Music vote item */
        .music-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 1rem;
            background: rgba(0, 0, 0, 0.02);
            border-radius: 0.5rem;
            transition: all 0.3s ease;
        }
        
        .music-item:hover {
            background: rgba(0, 0, 0, 0.05);
            transform: translateX(5px);
        }
        
        .vote-bar {
            height: 4px;
            background: #e5e7eb;
            border-radius: 2px;
            overflow: hidden;
            margin-top: 0.5rem;
        }
        
        .vote-fill {
            height: 100%;
            background: linear-gradient(90deg, var(--primary) 0%, var(--accent) 100%);
            transition: width 0.5s ease;
        }
        
        /* Photo booth filters */
        .filter-option {
            width: 80px;
            height: 80px;
            border-radius: 0.5rem;
            overflow: hidden;
            cursor: pointer;
            border: 3px solid transparent;
            transition: all 0.3s ease;
        }
        
        .filter-option.active {
            border-color: var(--primary);
            transform: scale(1.1);
        }
        
        /* Mobile optimizations */
        @media (max-width: 768px) {
            .modal-content {
                margin: 1rem;
                max-height: calc(100vh - 2rem);
            }
            
            .countdown-digit {
                font-size: 1.5rem;
                min-width: 60px;
            }
            
            .nav-icon span {
                font-size: 0.625rem;
            }
        }
        
        /* Loading state */
        .skeleton {
            background: linear-gradient(90deg, #f3f4f6 25%, #e5e7eb 50%, #f3f4f6 75%);
            background-size: 200% 100%;
            animation: shimmer 1.5s infinite;
        }
        
        /* Haptic feedback (mobile) */
        .haptic {
            -webkit-tap-highlight-color: rgba(4, 120, 87, 0.2);
        }
        
        /* Print styles */
        @media print {
            .no-print {
                display: none !important;
            }
        }
    </style>
</head>
<body class="bg-[#FEFBF6] text-stone-800 dark:bg-stone-900 dark:text-stone-200 antialiased">
    
    <!-- Confetti Container -->
    <div id="confetti-container" class="fixed inset-0 pointer-events-none z-50"></div>
    
    <!-- Toast Container -->
    <div id="toast" class="toast"></div>

    <div id="app-container" class="hidden">
        <!-- Enhanced Header -->
        <header class="glass-morphism sticky top-0 z-20 shadow-sm border-b border-stone-200/50 dark:border-stone-700/50 no-print">
            <div class="container mx-auto px-4 py-3">
                <div class="flex justify-between items-center">
                    <div class="flex items-center space-x-3">
                        <div class="animate-heartbeat text-2xl">💕</div>
                        <h1 class="text-xl font-bold bg-gradient-to-r from-emerald-600 to-pink-600 bg-clip-text text-transparent">
                            J&E Wedding Hub
                        </h1>
                    </div>
                    <div class="flex items-center space-x-4">
                        <div id="user-info" class="text-right">
                            <p id="user-display-name" class="font-semibold text-stone-700 dark:text-stone-300"></p>
                            <div class="flex items-center justify-end space-x-2 text-xs">
                                <span id="user-points" class="achievement-badge hidden">
                                    <i class="fas fa-star"></i>
                                    <span>0 pts</span>
                                </span>
                                <span class="text-stone-500 dark:text-stone-400">
                                    Guest #<span id="user-id-display"></span>
                                </span>
                            </div>
                        </div>
                        <button id="dark-mode-toggle" class="text-xl p-2 rounded-lg hover:bg-stone-100 dark:hover:bg-stone-800 transition" aria-label="Toggle dark mode">
                            <i class="fas fa-moon dark:hidden"></i>
                            <i class="fas fa-sun hidden dark:inline"></i>
                        </button>
                    </div>
                </div>
            </div>
        </header>

        <main id="main-content" class="container mx-auto px-4 py-6 pb-32">
            <!-- Home Page Enhanced -->
            <div id="page-home" class="page">
                <!-- Countdown Section -->
                <div class="wedding-card mb-6">
                    <h2 class="text-3xl font-bold text-center mb-6 font-script">
                        The Adventure Begins In...
                    </h2>
                    <div id="countdown" class="flex justify-center gap-3 mb-6">
                        <div class="text-center">
                            <div class="countdown-digit" id="days">00</div>
                            <p class="text-sm mt-2 text-stone-600 dark:text-stone-400">Days</p>
                        </div>
                        <div class="text-center">
                            <div class="countdown-digit" id="hours">00</div>
                            <p class="text-sm mt-2 text-stone-600 dark:text-stone-400">Hours</p>
                        </div>
                        <div class="text-center">
                            <div class="countdown-digit" id="minutes">00</div>
                            <p class="text-sm mt-2 text-stone-600 dark:text-stone-400">Minutes</p>
                        </div>
                        <div class="text-center">
                            <div class="countdown-digit" id="seconds">00</div>
                            <p class="text-sm mt-2 text-stone-600 dark:text-stone-400">Seconds</p>
                        </div>
                    </div>
                    <div class="love-meter rounded-full overflow-hidden">
                        <div class="love-meter-fill" style="width: 100%"></div>
                    </div>
                    <p class="text-center text-sm text-stone-600 dark:text-stone-400 mt-3">
                        Love meter: <span class="font-bold text-pink-600">OVERFLOWING!</span> 💕
                    </p>
                </div>

                <!-- Weather Widget -->
                <div class="weather-widget mb-6">
                    <div class="relative z-10">
                        <h3 class="font-bold text-lg mb-2">Wedding Day Weather</h3>
                        <div class="flex items-center justify-between">
                            <div>
                                <p class="text-3xl font-bold">78°F</p>
                                <p class="text-sm opacity-90">Partly Cloudy</p>
                            </div>
                            <div class="text-right">
                                <p class="text-sm">Sunset: 7:58 PM</p>
                                <p class="text-sm">Perfect beach weather!</p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Quick Actions -->
                <div class="grid grid-cols-2 md:grid-cols-4 gap-3 mb-6">
                    <button onclick="showPage('rsvp')" class="wedding-card p-4 text-center hover:scale-105 transition">
                        <i class="fas fa-envelope text-2xl text-emerald-600 mb-2"></i>
                        <p class="text-sm font-semibold">RSVP</p>
                    </button>
                    <button onclick="showPage('story')" class="wedding-card p-4 text-center hover:scale-105 transition">
                        <i class="fas fa-heart text-2xl text-pink-600 mb-2"></i>
                        <p class="text-sm font-semibold">Our Story</p>
                    </button>
                    <button onclick="showPage('party')" class="wedding-card p-4 text-center hover:scale-105 transition">
                        <i class="fas fa-users text-2xl text-purple-600 mb-2"></i>
                        <p class="text-sm font-semibold">Wedding Party</p>
                    </button>
                    <button onclick="showPage('music')" class="wedding-card p-4 text-center hover:scale-105 transition">
                        <i class="fas fa-music text-2xl text-blue-600 mb-2"></i>
                        <p class="text-sm font-semibold">Song Requests</p>
                    </button>
                </div>

                <!-- Event Feed -->
                <h3 class="text-xl font-bold mb-4 flex items-center">
                    <i class="fas fa-stream mr-2 text-emerald-600"></i>
                    Live Event Feed
                </h3>
                <div id="feed-posts" class="space-y-4">
                    <div class="skeleton h-32 rounded-lg"></div>
                    <div class="skeleton h-32 rounded-lg"></div>
                </div>
            </div>

            <!-- Enhanced Schedule Page -->
            <div id="page-schedule" class="page">
                <h2 class="text-3xl font-bold text-center mb-6 font-display">
                    <i class="fas fa-calendar-heart text-pink-600 mr-2"></i>
                    Wedding Weekend Schedule
                </h2>
                <div id="schedule-tabs" class="flex justify-center mb-6 space-x-2">
                    <button onclick="filterSchedule('all', this)" class="schedule-tab px-4 py-2 rounded-lg bg-emerald-600 text-white transition">
                        All Events
                    </button>
                    <button onclick="filterSchedule('wedding', this)" class="schedule-tab px-4 py-2 rounded-lg bg-stone-200 text-stone-700 hover:bg-stone-300 transition">
                        Wedding Only
                    </button>
                    <button onclick="filterSchedule('reunion', this)" class="schedule-tab px-4 py-2 rounded-lg bg-stone-200 text-stone-700 hover:bg-stone-300 transition">
                        Reunion Only
                    </button>
                </div>
                <div id="schedule-list" class="space-y-4"></div>
            </div>
            
            <!-- Enhanced Games Page -->
            <div id="page-games" class="page">
                <h2 class="text-3xl font-bold text-center mb-6 font-display">
                    <i class="fas fa-gamepad text-purple-600 mr-2"></i>
                    Games & Challenges
                </h2>
                
                <!-- Achievement Progress -->
                <div class="wedding-card mb-6">
                    <h3 class="text-lg font-bold mb-3">Your Achievements</h3>
                    <div class="grid grid-cols-3 md:grid-cols-6 gap-3" id="achievements-grid">
                        <!-- Achievements will be populated here -->
                    </div>
                </div>
                
                <div class="grid md:grid-cols-2 gap-6 max-w-4xl mx-auto">
                    <div class="game-card wedding-card" onclick="openModal('trivia-modal')">
                        <div class="text-center">
                            <i class="fas fa-brain text-4xl text-emerald-600 mb-3"></i>
                            <h3 class="text-2xl font-bold text-emerald-700 mb-2">Couple's Trivia</h3>
                            <p class="text-stone-600">Test your knowledge about Jaycee & Emily!</p>
                            <div class="mt-3">
                                <span class="text-xs bg-emerald-100 text-emerald-700 px-2 py-1 rounded-full">
                                    <i class="fas fa-trophy"></i> 50 points
                                </span>
                            </div>
                        </div>
                    </div>
                    
                    <div class="game-card wedding-card" onclick="openModal('bingo-modal')">
                        <div class="text-center">
                            <i class="fas fa-th text-4xl text-pink-600 mb-3"></i>
                            <h3 class="text-2xl font-bold text-pink-700 mb-2">Wedding Bingo</h3>
                            <p class="text-stone-600">Meet people & complete challenges!</p>
                            <div class="mt-3">
                                <span class="text-xs bg-pink-100 text-pink-700 px-2 py-1 rounded-full">
                                    <i class="fas fa-trophy"></i> 100 points
                                </span>
                            </div>
                        </div>
                    </div>
                    
                    <div class="game-card wedding-card" onclick="openModal('scavenger-modal')">
                        <div class="text-center">
                            <i class="fas fa-map-marked-alt text-4xl text-blue-600 mb-3"></i>
                            <h3 class="text-2xl font-bold text-blue-700 mb-2">Beach Hunt</h3>
                            <p class="text-stone-600">Explore Myrtle Beach locations!</p>
                            <div class="mt-3">
                                <span class="text-xs bg-blue-100 text-blue-700 px-2 py-1 rounded-full">
                                    <i class="fas fa-trophy"></i> 150 points
                                </span>
                            </div>
                        </div>
                    </div>
                    
                    <div class="game-card wedding-card" onclick="openModal('predictions-modal')">
                        <div class="text-center">
                            <i class="fas fa-crystal-ball text-4xl text-purple-600 mb-3"></i>
                            <h3 class="text-2xl font-bold text-purple-700 mb-2">Future Predictions</h3>
                            <p class="text-stone-600">Predict the couple's future!</p>
                            <div class="mt-3">
                                <span class="text-xs bg-purple-100 text-purple-700 px-2 py-1 rounded-full">
                                    <i class="fas fa-trophy"></i> 30 points
                                </span>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Leaderboard -->
                <div class="mt-8 wedding-card">
                    <h3 class="text-xl font-bold mb-4 flex items-center">
                        <i class="fas fa-trophy text-yellow-500 mr-2"></i>
                        Top Players
                    </h3>
                    <div id="leaderboard" class="space-y-2"></div>
                </div>
            </div>

            <!-- Enhanced Photo Gallery -->
            <div id="page-photos" class="page">
                <div class="flex justify-between items-center mb-6">
                    <h2 class="text-3xl font-bold font-display">
                        <i class="fas fa-camera text-pink-600 mr-2"></i>
                        Photo Memories
                    </h2>
                    <div class="flex space-x-2">
                        <button onclick="openModal('photo-booth-modal')" class="btn-primary text-sm">
                            <i class="fas fa-camera-retro mr-2"></i>
                            Photo Booth
                        </button>
                        <button id="generate-highlight-button" class="gemini-button font-semibold py-2 px-4 rounded-lg text-sm flex items-center">
                            <span class="mr-2">✨</span> AI Highlights
                        </button>
                    </div>
                </div>
                
                <!-- Photo Filters -->
                <div class="flex gap-2 mb-4 overflow-x-auto pb-2">
                    <button onclick="filterPhotos('all')" class="px-4 py-2 rounded-full bg-emerald-600 text-white text-sm whitespace-nowrap">
                        All Photos
                    </button>
                    <button onclick="filterPhotos('ceremony')" class="px-4 py-2 rounded-full bg-stone-200 text-stone-700 text-sm whitespace-nowrap">
                        Ceremony
                    </button>
                    <button onclick="filterPhotos('reception')" class="px-4 py-2 rounded-full bg-stone-200 text-stone-700 text-sm whitespace-nowrap">
                        Reception
                    </button>
                    <button onclick="filterPhotos('candid')" class="px-4 py-2 rounded-full bg-stone-200 text-stone-700 text-sm whitespace-nowrap">
                        Candids
                    </button>
                </div>
                
                <div id="photo-grid" class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-4"></div>
            </div>
            
            <!-- Enhanced Guestbook -->
            <div id="page-guestbook" class="page">
                <h2 class="text-3xl font-bold text-center mb-6 font-display">
                    <i class="fas fa-book-heart text-pink-600 mr-2"></i>
                    Digital Guestbook
                </h2>
                <p class="text-center text-stone-600 dark:text-stone-400 mb-8 max-w-2xl mx-auto">
                    Leave a heartfelt message, record a video toast, or share your favorite memory!
                </p>
                
                <!-- Message Type Tabs -->
                <div class="flex justify-center mb-6 space-x-2">
                    <button onclick="filterGuestbook('all')" class="px-4 py-2 rounded-lg bg-emerald-600 text-white">
                        All Messages
                    </button>
                    <button onclick="filterGuestbook('text')" class="px-4 py-2 rounded-lg bg-stone-200 text-stone-700">
                        Written
                    </button>
                    <button onclick="filterGuestbook('audio')" class="px-4 py-2 rounded-lg bg-stone-200 text-stone-700">
                        Audio
                    </button>
                    <button onclick="filterGuestbook('video')" class="px-4 py-2 rounded-lg bg-stone-200 text-stone-700">
                        Video
                    </button>
                </div>
                
                <div id="guestbook-messages" class="space-y-4"></div>
            </div>

            <!-- Enhanced Guide -->
            <div id="page-guide" class="page">
                <h2 class="text-3xl font-bold text-center mb-4 font-display">
                    <i class="fas fa-map-pin text-blue-600 mr-2"></i>
                    Myrtle Beach Guide
                </h2>
                <p class="text-center text-stone-600 dark:text-stone-400 mb-6">
                    Our favorite spots and must-visit places in Myrtle Beach!
                </p>
                <div class="flex flex-wrap justify-center gap-2 mb-6">
                    <button onclick="filterGuide('all', this)" class="guide-filter px-4 py-2 rounded-lg bg-emerald-600 text-white text-sm">
                        All Places
                    </button>
                    <button onclick="filterGuide('favorites', this)" class="guide-filter px-4 py-2 rounded-lg bg-stone-200 text-stone-700 text-sm">
                        ❤️ Our Favorites
                    </button>
                    <button onclick="filterGuide('dining', this)" class="guide-filter px-4 py-2 rounded-lg bg-stone-200 text-stone-700 text-sm">
                        🍽️ Dining
                    </button>
                    <button onclick="filterGuide('activities', this)" class="guide-filter px-4 py-2 rounded-lg bg-stone-200 text-stone-700 text-sm">
                        🎢 Activities
                    </button>
                    <button onclick="filterGuide('romantic', this)" class="guide-filter px-4 py-2 rounded-lg bg-stone-200 text-stone-700 text-sm">
                        💕 Romantic
                    </button>
                </div>
                <div id="guide-grid" class="grid sm:grid-cols-2 lg:grid-cols-3 gap-6"></div>
            </div>

            <!-- Guest Directory -->
            <div id="page-guests" class="page">
                <h2 class="text-3xl font-bold text-center mb-6 font-display">
                    <i class="fas fa-users text-purple-600 mr-2"></i>
                    Guest Directory
                </h2>
                <div class="mb-6">
                    <div class="relative">
                        <input type="text" id="guest-search" placeholder="Search guests by name or table..." 
                               class="rsvp-input pl-10">
                        <i class="fas fa-search absolute left-3 top-1/2 transform -translate-y-1/2 text-stone-400"></i>
                    </div>
                </div>
                <div id="guest-list" class="grid md:grid-cols-2 lg:grid-cols-3 gap-4"></div>
            </div>

            <!-- NEW: RSVP Page -->
            <div id="page-rsvp" class="page">
                <h2 class="text-3xl font-bold text-center mb-6 font-display">
                    <i class="fas fa-envelope-open-heart text-pink-600 mr-2"></i>
                    RSVP & Details
                </h2>
                <div class="max-w-2xl mx-auto">
                    <div class="wedding-card">
                        <h3 class="text-xl font-bold mb-4">Your RSVP Status</h3>
                        <div id="rsvp-status" class="mb-6">
                            <!-- RSVP status will be shown here -->
                        </div>
                        <form id="rsvp-form" class="space-y-4">
                            <div>
                                <label class="block text-sm font-medium mb-2">Will you attend?</label>
                                <div class="grid grid-cols-2 gap-3">
                                    <button type="button" onclick="setAttending(true)" class="rsvp-option p-4 border-2 rounded-lg text-center hover:border-emerald-500 transition">
                                        <i class="fas fa-check-circle text-2xl text-emerald-600 mb-2"></i>
                                        <p>Yes, I'll be there!</p>
                                    </button>
                                    <button type="button" onclick="setAttending(false)" class="rsvp-option p-4 border-2 rounded-lg text-center hover:border-red-500 transition">
                                        <i class="fas fa-times-circle text-2xl text-red-600 mb-2"></i>
                                        <p>Sorry, can't make it</p>
                                    </button>
                                </div>
                            </div>
                            <div id="rsvp-details" class="hidden space-y-4">
                                <div>
                                    <label class="block text-sm font-medium mb-2">Number of guests (including you)</label>
                                    <input type="number" id="guest-count" min="1" max="5" value="1" class="rsvp-input">
                                </div>
                                <div>
                                    <label class="block text-sm font-medium mb-2">Dietary restrictions</label>
                                    <textarea id="dietary-restrictions" rows="3" placeholder="Vegetarian, allergies, etc." class="rsvp-input"></textarea>
                                </div>
                                <div>
                                    <label class="block text-sm font-medium mb-2">Song requests for the reception</label>
                                    <input type="text" id="song-request" placeholder="What gets you on the dance floor?" class="rsvp-input">
                                </div>
                            </div>
                            <button type="submit" class="btn-primary w-full">
                                Update RSVP
                            </button>
                        </form>
                    </div>
                    
                    <!-- Table Assignment -->
                    <div class="wedding-card mt-6">
                        <h3 class="text-xl font-bold mb-4">Your Table Assignment</h3>
                        <div id="table-assignment" class="text-center py-8">
                            <i class="fas fa-chair text-4xl text-stone-400 mb-3"></i>
                            <p class="text-stone-600">Table assignments will be available closer to the wedding date</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- NEW: Love Story Timeline -->
            <div id="page-story" class="page">
                <h2 class="text-3xl font-bold text-center mb-6 font-display">
                    <i class="fas fa-heart text-pink-600 mr-2"></i>
                    Our Love Story
                </h2>
                <div class="max-w-3xl mx-auto">
                    <div class="timeline-container">
                        <div class="timeline-item">
                            <div class="wedding-card">
                                <h3 class="text-xl font-bold mb-2">First Meeting</h3>
                                <p class="text-sm text-stone-600 mb-2">September 15, 2019</p>
                                <p>We met at a mutual friend's beach bonfire. Emily was trying to roast a marshmallow and set it on fire. Jaycee heroically saved the s'more (and maybe stole Emily's heart).</p>
                            </div>
                        </div>
                        <div class="timeline-item">
                            <div class="wedding-card">
                                <h3 class="text-xl font-bold mb-2">First Date</h3>
                                <p class="text-sm text-stone-600 mb-2">October 3, 2019</p>
                                <p>Mini golf at Captain Hook's. Jaycee let Emily win (or so he claims). We ended the night sharing funnel cake on the boardwalk.</p>
                            </div>
                        </div>
                        <div class="timeline-item">
                            <div class="wedding-card">
                                <h3 class="text-xl font-bold mb-2">The Proposal</h3>
                                <p class="text-sm text-stone-600 mb-2">June 12, 2024</p>
                                <p>On the same beach where we first met, during sunset, Jaycee got down on one knee. Emily said yes before he could even finish asking!</p>
                            </div>
                        </div>
                        <div class="timeline-item">
                            <div class="wedding-card">
                                <h3 class="text-xl font-bold mb-2">Wedding Day</h3>
                                <p class="text-sm text-stone-600 mb-2">July 27, 2025</p>
                                <p>The best day of our lives, celebrating with all of you! 💕</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- NEW: Wedding Party -->
            <div id="page-party" class="page">
                <h2 class="text-3xl font-bold text-center mb-6 font-display">
                    <i class="fas fa-user-friends text-purple-600 mr-2"></i>
                    Meet the Wedding Party
                </h2>
                <div class="grid md:grid-cols-2 gap-8 max-w-4xl mx-auto">
                    <div>
                        <h3 class="text-2xl font-bold text-center mb-4 text-pink-600">Bride's Side</h3>
                        <div class="space-y-4">
                            <div class="wedding-card flex items-center">
                                <div class="w-20 h-20 rounded-full bg-pink-100 flex items-center justify-center mr-4">
                                    <i class="fas fa-crown text-2xl text-pink-600"></i>
                                </div>
                                <div>
                                    <h4 class="font-bold">Sarah Johnson</h4>
                                    <p class="text-sm text-stone-600">Maid of Honor</p>
                                    <p class="text-xs mt-1">Emily's sister and partner in crime since birth</p>
                                </div>
                            </div>
                            <div class="wedding-card flex items-center">
                                <div class="w-20 h-20 rounded-full bg-pink-100 flex items-center justify-center mr-4">
                                    <i class="fas fa-user text-2xl text-pink-600"></i>
                                </div>
                                <div>
                                    <h4 class="font-bold">Ashley Martinez</h4>
                                    <p class="text-sm text-stone-600">Bridesmaid</p>
                                    <p class="text-xs mt-1">College roommate and karaoke partner</p>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div>
                        <h3 class="text-2xl font-bold text-center mb-4 text-emerald-600">Groom's Side</h3>
                        <div class="space-y-4">
                            <div class="wedding-card flex items-center">
                                <div class="w-20 h-20 rounded-full bg-emerald-100 flex items-center justify-center mr-4">
                                    <i class="fas fa-crown text-2xl text-emerald-600"></i>
                                </div>
                                <div>
                                    <h4 class="font-bold">Michael Williams</h4>
                                    <p class="text-sm text-stone-600">Best Man</p>
                                    <p class="text-xs mt-1">Jaycee's brother and golf buddy</p>
                                </div>
                            </div>
                            <div class="wedding-card flex items-center">
                                <div class="w-20 h-20 rounded-full bg-emerald-100 flex items-center justify-center mr-4">
                                    <i class="fas fa-user text-2xl text-emerald-600"></i>
                                </div>
                                <div>
                                    <h4 class="font-bold">David Chen</h4>
                                    <p class="text-sm text-stone-600">Groomsman</p>
                                    <p class="text-xs mt-1">High school friend and fantasy football rival</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- NEW: Music Requests -->
            <div id="page-music" class="page">
                <h2 class="text-3xl font-bold text-center mb-6 font-display">
                    <i class="fas fa-music text-blue-600 mr-2"></i>
                    Reception Playlist
                </h2>
                <p class="text-center text-stone-600 mb-6">Help us create the perfect dance floor playlist!</p>
                
                <div class="max-w-2xl mx-auto">
                    <!-- Add Song Request -->
                    <div class="wedding-card mb-6">
                        <h3 class="text-lg font-bold mb-3">Request a Song</h3>
                        <div class="flex gap-2">
                            <input type="text" id="song-input" placeholder="Song title - Artist" class="rsvp-input flex-1">
                            <button onclick="requestSong()" class="btn-primary">
                                <i class="fas fa-plus"></i>
                            </button>
                        </div>
                    </div>
                    
                    <!-- Top Requested Songs -->
                    <div class="wedding-card">
                        <h3 class="text-lg font-bold mb-4">Top Requested Songs</h3>
                        <div id="song-list" class="space-y-3">
                            <!-- Songs will be populated here -->
                        </div>
                    </div>
                </div>
            </div>
        </main>

        <!-- Enhanced Floating Action Buttons -->
        <div id="fab-container" class="fixed bottom-28 right-5 z-20 flex flex-col space-y-3"></div>

        <!-- Enhanced Navigation -->
        <nav class="fixed bottom-0 left-0 right-0 glass-morphism border-t border-stone-200/50 dark:border-stone-700/50 shadow-t-sm z-30 no-print">
            <div class="container mx-auto grid grid-cols-5 text-center py-2">
                <button onclick="showPage('home')" class="nav-icon active flex flex-col items-center py-2 text-stone-600 dark:text-stone-400 hover:text-emerald-700 dark:hover:text-emerald-500 transition haptic">
                    <i class="fas fa-home text-xl mb-1"></i>
                    <span class="text-xs">Home</span>
                </button>
                <button onclick="showPage('schedule')" class="nav-icon flex flex-col items-center py-2 text-stone-600 dark:text-stone-400 hover:text-emerald-700 dark:hover:text-emerald-500 transition haptic">
                    <i class="fas fa-calendar text-xl mb-1"></i>
                    <span class="text-xs">Schedule</span>
                </button>
                <button onclick="showPage('photos')" class="nav-icon flex flex-col items-center py-2 text-stone-600 dark:text-stone-400 hover:text-emerald-700 dark:hover:text-emerald-500 transition haptic">
                    <i class="fas fa-camera text-xl mb-1"></i>
                    <span class="text-xs">Photos</span>
                </button>
                <button onclick="showPage('games')" class="nav-icon flex flex-col items-center py-2 text-stone-600 dark:text-stone-400 hover:text-emerald-700 dark:hover:text-emerald-500 transition haptic">
                    <i class="fas fa-gamepad text-xl mb-1"></i>
                    <span class="text-xs">Games</span>
                </button>
                <button onclick="toggleMoreMenu()" class="nav-icon flex flex-col items-center py-2 text-stone-600 dark:text-stone-400 hover:text-emerald-700 dark:hover:text-emerald-500 transition haptic">
                    <i class="fas fa-ellipsis-h text-xl mb-1"></i>
                    <span class="text-xs">More</span>
                </button>
            </div>
        </nav>

        <!-- More Menu Overlay -->
        <div id="more-menu" class="fixed bottom-20 right-4 glass-morphism rounded-lg shadow-xl p-2 hidden z-40 min-w-[200px]">
            <button onclick="showPage('guestbook'); toggleMoreMenu()" class="w-full text-left px-4 py-3 hover:bg-stone-100 dark:hover:bg-stone-800 rounded transition flex items-center">
                <i class="fas fa-book-heart mr-3 text-pink-600"></i> Guestbook
            </button>
            <button onclick="showPage('guide'); toggleMoreMenu()" class="w-full text-left px-4 py-3 hover:bg-stone-100 dark:hover:bg-stone-800 rounded transition flex items-center">
                <i class="fas fa-map mr-3 text-blue-600"></i> Local Guide
            </button>
            <button onclick="showPage('guests'); toggleMoreMenu()" class="w-full text-left px-4 py-3 hover:bg-stone-100 dark:hover:bg-stone-800 rounded transition flex items-center">
                <i class="fas fa-users mr-3 text-purple-600"></i> Guests
            </button>
            <button onclick="showPage('rsvp'); toggleMoreMenu()" class="w-full text-left px-4 py-3 hover:bg-stone-100 dark:hover:bg-stone-800 rounded transition flex items-center">
                <i class="fas fa-envelope mr-3 text-emerald-600"></i> RSVP
            </button>
            <button onclick="showPage('story'); toggleMoreMenu()" class="w-full text-left px-4 py-3 hover:bg-stone-100 dark:hover:bg-stone-800 rounded transition flex items-center">
                <i class="fas fa-heart mr-3 text-red-600"></i> Our Story
            </button>
            <button onclick="showPage('party'); toggleMoreMenu()" class="w-full text-left px-4 py-3 hover:bg-stone-100 dark:hover:bg-stone-800 rounded transition flex items-center">
                <i class="fas fa-user-friends mr-3 text-indigo-600"></i> Wedding Party
            </button>
            <button onclick="showPage('music'); toggleMoreMenu()" class="w-full text-left px-4 py-3 hover:bg-stone-100 dark:hover:bg-stone-800 rounded transition flex items-center">
                <i class="fas fa-music mr-3 text-cyan-600"></i> Music
            </button>
            <div class="border-t border-stone-200 dark:border-stone-700 my-2"></div>
            <a href="https://www.amazon.com/wedding/registry/1I8SUL5YPLE9V" target="_blank" class="w-full text-left px-4 py-3 hover:bg-stone-100 dark:hover:bg-stone-800 rounded transition flex items-center">
                <i class="fas fa-gift mr-3 text-yellow-600"></i> Registry
            </a>
        </div>
    </div>

    <!-- Enhanced Login Screen -->
    <div id="login-screen" class="min-h-screen flex items-center justify-center p-4 bg-gradient-to-br from-pink-50 via-white to-emerald-50">
        <div class="max-w-md w-full">
            <div class="text-center mb-8 animate-float">
                <div class="text-6xl mb-4">💕</div>
                <h1 class="text-5xl font-bold text-stone-800 mb-2 font-script">Welcome to</h1>
                <h2 class="text-4xl font-display bg-gradient-to-r from-emerald-600 to-pink-600 bg-clip-text text-transparent">
                    Jaycee & Emily's Wedding
                </h2>
            </div>
            
            <div class="wedding-card backdrop-blur-lg bg-white/90">
                <div class="text-center mb-6">
                    <p class="text-lg text-stone-600">July 27th, 2025</p>
                    <p class="text-stone-600">Myrtle Beach, South Carolina</p>
                </div>
                
                <div class="space-y-4">
                    <input id="display-name-input" type="text" placeholder="Enter your full name" 
                           class="rsvp-input text-center text-lg">
                    <select id="relationship-select" class="rsvp-input text-center">
                        <option value="">How do you know the couple?</option>
                        <option value="Groom's Family">Groom's Family</option>
                        <option value="Bride's Family">Bride's Family</option>
                        <option value="Groom's Friend">Groom's Friend</option>
                        <option value="Bride's Friend">Bride's Friend</option>
                        <option value="Wedding Party">Wedding Party</option>
                        <option value="Work Colleague">Work Colleague</option>
                        <option value="Other">Other</option>
                    </select>
                    <button id="join-button" class="btn-primary w-full text-lg">
                        Join the Celebration! 🎉
                    </button>
                </div>
            </div>
            
            <p class="text-center text-sm text-stone-500 mt-6">
                By joining, you agree to share the love and joy of this special day
            </p>
        </div>
    </div>
    
    <!-- Enhanced Modals -->
    <!-- Post Modal -->
    <div id="post-modal" class="modal-backdrop fixed inset-0 bg-black bg-opacity-50 z-40 flex items-center justify-center p-4 opacity-0 pointer-events-none">
        <div class="modal-content bg-white dark:bg-stone-800 rounded-lg shadow-xl w-full max-w-md transform scale-95">
            <div class="p-6">
                <h3 class="text-2xl font-bold mb-4">Share a Moment 💭</h3>
                <textarea id="post-text-input" placeholder="Share a memory, well-wish, or update..." 
                          class="rsvp-input h-24"></textarea>
                <div class="flex justify-between items-center mt-4">
                    <button id="suggest-post-button" class="gemini-button font-semibold py-2 px-3 rounded-lg text-sm flex items-center">
                        <span class="mr-2">✨</span> AI Suggest
                    </button>
                    <div class="flex space-x-3">
                        <button onclick="closeModal('post-modal')" class="px-4 py-2 rounded-lg border border-stone-300 text-stone-700 hover:bg-stone-100">
                            Cancel
                        </button>
                        <button id="submit-post-button" class="btn-primary">
                            Post
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Photo Modal -->
    <div id="photo-modal" class="modal-backdrop fixed inset-0 bg-black bg-opacity-50 z-40 flex items-center justify-center p-4 opacity-0 pointer-events-none">
        <div class="modal-content bg-white dark:bg-stone-800 rounded-lg shadow-xl w-full max-w-md transform scale-95">
            <div class="p-6">
                <h3 class="text-2xl font-bold mb-4">Add a Photo 📸</h3>
                <div class="space-y-4">
                    <input type="file" id="photo-file-input" class="hidden" accept="image/*">
                    <label for="photo-file-input" class="block w-full text-center p-8 border-2 border-dashed border-emerald-300 rounded-lg hover:border-emerald-500 cursor-pointer transition bg-emerald-50 dark:bg-emerald-900/20">
                        <i class="fas fa-cloud-upload-alt text-4xl text-emerald-600 mb-2"></i>
                        <span id="file-chosen-text" class="block text-stone-600 dark:text-stone-400">
                            Click to choose a photo
                        </span>
                    </label>
                    <select id="photo-category" class="rsvp-input">
                        <option value="candid">Candid Moment</option>
                        <option value="ceremony">Ceremony</option>
                        <option value="reception">Reception</option>
                        <option value="group">Group Photo</option>
                    </select>
                    <textarea id="photo-caption-input" placeholder="Add a caption..." 
                              class="rsvp-input h-20"></textarea>
                </div>
                <div id="upload-progress-container" class="w-full bg-gray-200 rounded-full h-2.5 mt-4 hidden overflow-hidden">
                    <div id="upload-progress-bar" class="bg-gradient-to-r from-emerald-500 to-emerald-600 h-2.5 rounded-full transition-all duration-300" 
                         style="width: 0%"></div>
                </div>
                <div class="flex justify-end space-x-3 mt-4">
                    <button onclick="closeModal('photo-modal')" class="px-4 py-2 rounded-lg border border-stone-300 text-stone-700 hover:bg-stone-100">
                        Cancel
                    </button>
                    <button id="submit-photo-button" class="btn-primary" disabled>
                        Upload Photo
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Photo Booth Modal -->
    <div id="photo-booth-modal" class="modal-backdrop fixed inset-0 bg-black bg-opacity-50 z-40 flex items-center justify-center p-4 opacity-0 pointer-events-none">
        <div class="modal-content bg-white dark:bg-stone-800 rounded-lg shadow-xl w-full max-w-2xl transform scale-95">
            <div class="p-6">
                <h3 class="text-2xl font-bold mb-4">Photo Booth 📸</h3>
                <div class="relative">
                    <video id="photo-booth-video" class="w-full rounded-lg mb-4" autoplay></video>
                    <canvas id="photo-booth-canvas" class="hidden"></canvas>
                    <div id="photo-booth-preview" class="hidden w-full rounded-lg mb-4"></div>
                </div>
                
                <!-- Filters -->
                <div class="flex gap-2 mb-4 overflow-x-auto pb-2">
                    <div class="filter-option active" onclick="setPhotoFilter('none')">
                        <img src="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='80' height='80'%3E%3Crect width='80' height='80' fill='%23f3f4f6'/%3E%3Ctext x='50%25' y='50%25' text-anchor='middle' dy='.3em' font-family='sans-serif' font-size='12' fill='%23374151'%3ENone%3C/text%3E%3C/svg%3E" alt="None">
                    </div>
                    <div class="filter-option" onclick="setPhotoFilter('wedding')">
                        <img src="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='80' height='80'%3E%3Crect width='80' height='80' fill='%23fce7f3'/%3E%3Ctext x='50%25' y='50%25' text-anchor='middle' dy='.3em' font-family='sans-serif' font-size='12' fill='%23be185d'%3EWedding%3C/text%3E%3C/svg%3E" alt="Wedding">
                    </div>
                    <div class="filter-option" onclick="setPhotoFilter('beach')">
                        <img src="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='80' height='80'%3E%3Crect width='80' height='80' fill='%23dbeafe'/%3E%3Ctext x='50%25' y='50%25' text-anchor='middle' dy='.3em' font-family='sans-serif' font-size='12' fill='%231e40af'%3EBeach%3C/text%3E%3C/svg%3E" alt="Beach">
                    </div>
                </div>
                
                <div class="flex justify-between">
                    <button onclick="closeModal('photo-booth-modal')" class="px-4 py-2 rounded-lg border border-stone-300 text-stone-700 hover:bg-stone-100">
                        Close
                    </button>
                    <div class="space-x-3">
                        <button id="capture-photo-btn" onclick="capturePhoto()" class="btn-primary">
                            <i class="fas fa-camera mr-2"></i> Capture
                        </button>
                        <button id="save-photo-btn" onclick="saveBoothPhoto()" class="btn-primary hidden">
                            <i class="fas fa-save mr-2"></i> Save & Share
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Enhanced Guestbook Modal -->
    <div id="guestbook-input-modal" class="modal-backdrop fixed inset-0 bg-black bg-opacity-50 z-40 flex items-center justify-center p-4 opacity-0 pointer-events-none">
        <div class="modal-content bg-white dark:bg-stone-800 rounded-lg shadow-xl w-full max-w-md transform scale-95">
            <div class="p-6">
                <h3 class="text-2xl font-bold mb-4">Leave a Message 💌</h3>
                
                <!-- Text Message Form -->
                <div id="text-message-form" class="message-form">
                    <textarea id="guestbook-text-input" placeholder="Write your heartfelt message for Jaycee & Emily..." 
                              class="rsvp-input h-32 mb-4"></textarea>
                    <div class="flex justify-between items-center">
                        <button id="suggest-message-button" class="gemini-button font-semibold py-2 px-3 rounded-lg text-sm flex items-center">
                            <span class="mr-2">✨</span> AI Suggest
                        </button>
                        <div class="flex space-x-3">
                            <button onclick="closeModal('guestbook-input-modal')" class="px-4 py-2 rounded-lg border border-stone-300 text-stone-700 hover:bg-stone-100">
                                Cancel
                            </button>
                            <button id="submit-text-message" class="btn-primary">
                                Submit
                            </button>
                        </div>
                    </div>
                </div>
                
                <!-- Audio Message Form -->
                <div id="audio-message-form" class="message-form hidden">
                    <div class="text-center py-8">
                        <p class="text-stone-600 mb-4">Press and hold to record your message</p>
                        <button id="record-audio-button" class="bg-red-500 text-white rounded-full p-6 shadow-lg hover:bg-red-600 transition duration-300">
                            <i class="fas fa-microphone text-3xl"></i>
                        </button>
                        <p id="record-status" class="text-sm text-stone-500 mt-3 h-5"></p>
                        <div id="audio-waveform" class="mt-4 h-16 hidden">
                            <!-- Audio visualization would go here -->
                        </div>
                    </div>
                    <div class="flex justify-end space-x-3 mt-4">
                        <button onclick="closeModal('guestbook-input-modal')" class="px-4 py-2 rounded-lg border border-stone-300 text-stone-700 hover:bg-stone-100">
                            Cancel
                        </button>
                    </div>
                </div>
                
                <!-- Video Message Form -->
                <div id="video-message-form" class="message-form hidden">
                    <div class="text-center">
                        <video id="video-preview" class="w-full rounded-lg mb-4 hidden" autoplay muted></video>
                        <button id="record-video-button" class="bg-red-500 text-white rounded-full p-6 shadow-lg hover:bg-red-600 transition">
                            <i class="fas fa-video text-3xl"></i>
                        </button>
                        <p id="video-status" class="text-sm text-stone-500 mt-3"></p>
                    </div>
                    <div class="flex justify-end space-x-3 mt-4">
                        <button onclick="closeModal('guestbook-input-modal')" class="px-4 py-2 rounded-lg border border-stone-300 text-stone-700 hover:bg-stone-100">
                            Cancel
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Enhanced Game Modals -->
    <!-- Trivia Modal -->
    <div id="trivia-modal" class="modal-backdrop fixed inset-0 bg-black bg-opacity-50 z-40 flex items-center justify-center p-4 opacity-0 pointer-events-none">
        <div id="trivia-content" class="modal-content bg-white dark:bg-stone-800 rounded-lg shadow-xl w-full max-w-lg transform scale-95 p-6">
            <!-- Trivia content will be populated here -->
        </div>
    </div>

    <!-- Other modals remain similar but with enhanced styling -->
    
    <!-- Photo Lightbox -->
    <div id="photo-lightbox" class="fixed inset-0 bg-black bg-opacity-95 z-50 hidden flex items-center justify-center p-4">
        <button onclick="closeLightbox()" class="absolute top-4 right-4 text-white text-3xl hover:text-stone-300">
            <i class="fas fa-times"></i>
        </button>
        <button onclick="previousPhoto()" class="absolute left-4 text-white text-3xl hover:text-stone-300">
            <i class="fas fa-chevron-left"></i>
        </button>
        <button onclick="nextPhoto()" class="absolute right-4 text-white text-3xl hover:text-stone-300">
            <i class="fas fa-chevron-right"></i>
        </button>
        <div class="max-w-5xl max-h-[90vh]">
            <img id="lightbox-image" src="" alt="" class="max-w-full max-h-full rounded-lg">
            <div class="text-white text-center mt-4">
                <p id="lightbox-caption" class="text-lg"></p>
                <p id="lightbox-author" class="text-sm text-stone-400"></p>
            </div>
        </div>
    </div>

    <!-- Enhanced Script Section -->
    <script type="module">
        // Import Firebase modules
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, setDoc, addDoc, collection, query, onSnapshot, serverTimestamp, getDocs, updateDoc, where, orderBy, limit, increment } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { getStorage, ref, uploadBytesResumable, getDownloadURL } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-storage.js";

        // --- GLOBAL VARIABLES ---
        let app, auth, db, storage;
        let currentUser = null;
        let currentUnsubscribes = [];
        let mediaRecorder;
        let audioChunks = [];
        let currentPhotoFilter = 'none';
        let photoBoothStream = null;
        let lightboxPhotos = [];
        let currentLightboxIndex = 0;

// For Firebase JS SDK v7.20.0 and later, measurementId is optional
const firebaseConfig = {
  apiKey: "AIzaSyDe-yqRr9nKvh4azzYPMRP8cvBUs7k2mfg",
  authDomain: "williams-wedding-hub.firebaseapp.com",
  projectId: "williams-wedding-hub",
  storageBucket: "williams-wedding-hub.appspot.com",
  messagingSenderId: "554261439707",
  appId: "1:554261439707:web:a9c9aee62db3cff7a6d8fe",
  measurementId: "G-K6H5J1ZLNE"
};
        
        const geminiApiKey = "AIzaSyCV3bEJGDZOg2LHdfDusA_pdHm9dcxavpk";
        const appId = 'williams-wedding-2025';
        const USER_STORAGE_KEY = `weddingHubUser_${appId}`;

        // Achievement definitions
        const achievements = [
            { id: 'first_post', name: 'First Share', icon: '📝', points: 10, description: 'Share your first post' },
            { id: 'photographer', name: 'Photographer', icon: '📸', points: 20, description: 'Upload 5 photos' },
            { id: 'social_butterfly', name: 'Social Butterfly', icon: '🦋', points: 30, description: 'Complete wedding bingo' },
            { id: 'love_prophet', name: 'Love Prophet', icon: '🔮', points: 25, description: 'Make predictions' },
            { id: 'memory_keeper', name: 'Memory Keeper', icon: '💭', points: 15, description: 'Leave a guestbook message' },
            { id: 'trivia_master', name: 'Trivia Master', icon: '🧠', points: 50, description: 'Perfect trivia score' }
        ];

        // --- INITIALIZATION ---
        async function initialize() {
            app = initializeApp(firebaseConfig);
            auth = getAuth(app);
            db = getFirestore(app);
            storage = getStorage(app);

            onAuthStateChanged(auth, async (user) => {
                if (user) {
                    const userDocRef = doc(db, `artifacts/${appId}/public/data/users/${user.uid}`);
                    const userDoc = await getDoc(userDocRef);
                    if (userDoc.exists()) {
                        currentUser = { uid: user.uid, ...userDoc.data() };
                        localStorage.setItem(USER_STORAGE_KEY, JSON.stringify(currentUser));
                        showApp();
                    } else {
                        // This case handles if auth state exists but DB doc is missing.
                        // The join button logic will create the doc.
                        loginScreen.classList.remove('hidden');
                        appContainer.classList.add('hidden');
                    }
                } else {
                    loginScreen.classList.remove('hidden');
                    appContainer.classList.add('hidden');
                }
            });
        }

        // --- AUTHENTICATION ---
        const loginScreen = document.getElementById('login-screen');
        const appContainer = document.getElementById('app-container');
        const joinButton = document.getElementById('join-button');
        const displayNameInput = document.getElementById('display-name-input');
        const relationshipSelect = document.getElementById('relationship-select');

        joinButton.addEventListener('click', async () => {
            const displayName = displayNameInput.value.trim();
            const relationship = relationshipSelect.value;
            
            if (!displayName || !relationship) {
                showToast("Please fill in all fields", "error");
                return;
            }
            
            try {
                joinButton.disabled = true;
                joinButton.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i> Joining...';
                
                const userCredential = await signInAnonymously(auth);
                const user = userCredential.user;
                
                const userDocRef = doc(db, `artifacts/${appId}/public/data/users/${user.uid}`);
                const newUserData = {
                    displayName: displayName,
                    relationship: relationship,
                    points: 0,
                    achievements: [],
                    photoCount: 0,
                    postCount: 0
                };

                await setDoc(userDocRef, {
                    ...newUserData,
                    createdAt: serverTimestamp(),
                });
                
                // **FIX:** Manually set current user and show the app to avoid race condition
                currentUser = { uid: user.uid, ...newUserData };
                localStorage.setItem(USER_STORAGE_KEY, JSON.stringify(currentUser));
                
                showApp();
                celebrateJoin();

            } catch (error) {
                console.error("Error joining event: ", error);
                showToast("Could not join. Please try again.", "error");
                joinButton.disabled = false;
                joinButton.innerHTML = 'Join the Celebration! 🎉';
            }
        });

        // --- UI & NAVIGATION ---
        function showApp() {
            loginScreen.classList.add('hidden');
            appContainer.classList.remove('hidden');
            document.getElementById('user-display-name').textContent = currentUser.displayName;
            document.getElementById('user-id-display').textContent = currentUser.uid.slice(-6);
            updatePointsDisplay();
            startCountdown();
            showPage('home');
            loadGuestList();
            checkAchievements();
        }

        function updatePointsDisplay() {
            const pointsEl = document.getElementById('user-points');
            if (currentUser.points > 0) {
                pointsEl.classList.remove('hidden');
                pointsEl.querySelector('span:last-child').textContent = `${currentUser.points} pts`;
            }
        }

        window.showPage = (pageId) => {
            // Cleanup previous page listeners
            currentUnsubscribes.forEach(unsub => unsub());
            currentUnsubscribes = [];

            // Hide more menu if open
            document.getElementById('more-menu').classList.add('hidden');

            // Switch active page with animation
            document.querySelectorAll('.page').forEach(p => {
                p.classList.remove('active');
                p.style.animation = 'none';
            });
            const newPage = document.getElementById(`page-${pageId}`);
            newPage.classList.add('active');
            newPage.style.animation = 'slide-up 0.5s ease-out';
            
            // Update navigation
            document.querySelectorAll('.nav-icon').forEach(icon => {
                icon.classList.remove('active');
            });
            
            // Update FAB
            updateFab(pageId);
            
            // Load page-specific data
            switch(pageId) {
                case 'home': loadFeed(); break;
                case 'schedule': loadSchedule(); break;
                case 'photos': loadPhotos(); break;
                case 'games': loadGames(); break;
                case 'guestbook': loadGuestbook(); break;
                case 'guide': loadGuide('all'); break;
                case 'guests': renderGuestList(); break;
                case 'rsvp': loadRSVP(); break;
                case 'story': break; // Static content
                case 'party': break; // Static content
                case 'music': loadMusicRequests(); break;
            }
            
            // Scroll to top
            window.scrollTo(0, 0);
        }

        function updateFab(pageId) {
            const fabContainer = document.getElementById('fab-container');
            let fabHTML = '';
            
            switch(pageId) {
                case 'home':
                    fabHTML = `
                        <button onclick="openModal('post-modal')" class="btn-primary rounded-full p-4 shadow-lg">
                            <i class="fas fa-plus text-xl"></i>
                        </button>
                    `;
                    break;
                case 'photos':
                    fabHTML = `
                        <button onclick="openModal('photo-modal')" class="btn-primary rounded-full p-4 shadow-lg">
                            <i class="fas fa-camera text-xl"></i>
                        </button>
                    `;
                    break;
                case 'guestbook':
                    fabHTML = `
                        <div class="flex flex-col space-y-3">
                            <button onclick="openGuestbookModal('video')" class="btn-primary rounded-full p-3 shadow-lg">
                                <i class="fas fa-video text-lg"></i>
                            </button>
                            <button onclick="openGuestbookModal('audio')" class="btn-primary rounded-full p-3 shadow-lg">
                                <i class="fas fa-microphone text-lg"></i>
                            </button>
                            <button onclick="openGuestbookModal('text')" class="btn-primary rounded-full p-4 shadow-lg">
                                <i class="fas fa-pen text-xl"></i>
                            </button>
                        </div>
                    `;
                    break;
            }
            
            fabContainer.innerHTML = fabHTML;
        }

        // --- UTILITIES ---
        window.showToast = (message, type = 'success') => {
            const toast = document.getElementById('toast');
            toast.textContent = message;
            toast.className = `toast show ${type === 'error' ? 'bg-red-600' : 'bg-green-600'}`;
            setTimeout(() => {
                toast.classList.remove('show');
            }, 3000);
        }

        window.celebrateJoin = () => {
            // Create confetti
            const colors = ['#ec4899', '#10b981', '#f59e0b', '#3b82f6', '#8b5cf6'];
            for (let i = 0; i < 50; i++) {
                setTimeout(() => {
                    const confetti = document.createElement('div');
                    confetti.className = 'confetti';
                    confetti.style.left = Math.random() * 100 + '%';
                    confetti.style.backgroundColor = colors[Math.floor(Math.random() * colors.length)];
                    confetti.style.animationDuration = (Math.random() * 3 + 2) + 's';
                    confetti.style.animationDelay = Math.random() * 0.5 + 's';
                    document.getElementById('confetti-container').appendChild(confetti);
                    setTimeout(() => confetti.remove(), 5000);
                }, i * 50);
            }
        }

        async function updateUserPoints(points, achievementId = null) {
            if (!currentUser) return;
            
            const userRef = doc(db, `artifacts/${appId}/public/data/users/${currentUser.uid}`);
            const updates = { points: increment(points) };
            
            if (achievementId && !currentUser.achievements?.includes(achievementId)) {
                const userDoc = await getDoc(userRef);
                const currentAchievements = userDoc.data()?.achievements || [];
                currentAchievements.push(achievementId);
                updates.achievements = currentAchievements;
                
                // Show achievement notification
                const achievement = achievements.find(a => a.id === achievementId);
                if (achievement) {
                    showToast(`🎉 Achievement Unlocked: ${achievement.name}! +${achievement.points}pts`);
                }
            }
            
            await updateDoc(userRef, updates);
            currentUser.points = (currentUser.points || 0) + points;
            updatePointsDisplay();
        }

        async function checkAchievements() {
            if (!currentUser) return;
            
            const userRef = doc(db, `artifacts/${appId}/public/data/users/${currentUser.uid}`);
            const userDoc = await getDoc(userRef);
            const userData = userDoc.data();
            
            // Check various achievement conditions
            if (userData.postCount >= 1 && !userData.achievements?.includes('first_post')) {
                await updateUserPoints(10, 'first_post');
            }
            
            if (userData.photoCount >= 5 && !userData.achievements?.includes('photographer')) {
                await updateUserPoints(20, 'photographer');
            }
            
            // Update achievement display
            if (document.getElementById('achievements-grid')) {
                renderAchievements();
            }
        }

        function renderAchievements() {
            const grid = document.getElementById('achievements-grid');
            if (!grid) return;
            
            grid.innerHTML = achievements.map(achievement => {
                const earned = currentUser.achievements?.includes(achievement.id);
                return `
                    <div class="text-center ${earned ? '' : 'opacity-50'}">
                        <div class="text-3xl mb-1">${achievement.icon}</div>
                        <p class="text-xs">${achievement.name}</p>
                    </div>
                `;
            }).join('');
        }

        // --- MODAL MANAGEMENT ---
        window.openModal = (modalId) => {
            const modal = document.getElementById(modalId);
            modal.classList.remove('pointer-events-none', 'opacity-0');
            modal.querySelector('.modal-content').classList.remove('scale-95');
            
            // Specific modal setup
            switch(modalId) {
                case 'trivia-modal': startTrivia(); break;
                case 'bingo-modal': startBingo(); break;
                case 'scavenger-modal': startScavengerHunt(); break;
                case 'predictions-modal': startPredictions(); break;
                case 'photo-booth-modal': initPhotoBoooth(); break;
            }
        }

        window.closeModal = (modalId) => {
            const modal = document.getElementById(modalId);
            modal.classList.add('opacity-0');
            modal.querySelector('.modal-content').classList.add('scale-95');
            setTimeout(() => modal.classList.add('pointer-events-none'), 300);
            
            // Cleanup
            if (modalId === 'photo-booth-modal' && photoBoothStream) {
                photoBoothStream.getTracks().forEach(track => track.stop());
                photoBoothStream = null;
            }
        }

        // --- COUNTDOWN ---
        function startCountdown() {
            const weddingDate = new Date('2025-07-27T16:00:00-04:00');
            const updateCountdown = () => {
                const now = new Date();
                const diff = weddingDate - now;
                
                if (diff <= 0) {
                    document.getElementById('countdown').innerHTML = `
                        <div class="text-3xl font-bold text-emerald-700 animate-pulse">
                            🎉 The Big Day is Here! 🎉
                        </div>
                    `;
                    celebrateJoin();
                    return;
                }
                
                const days = Math.floor(diff / (1000 * 60 * 60 * 24));
                const hours = Math.floor((diff % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
                const minutes = Math.floor((diff % (1000 * 60 * 60)) / (1000 * 60));
                const seconds = Math.floor((diff % (1000 * 60)) / 1000);
                
                document.getElementById('days').textContent = days.toString().padStart(2, '0');
                document.getElementById('hours').textContent = hours.toString().padStart(2, '0');
                document.getElementById('minutes').textContent = minutes.toString().padStart(2, '0');
                document.getElementById('seconds').textContent = seconds.toString().padStart(2, '0');
            };
            
            updateCountdown();
            setInterval(updateCountdown, 1000);
        }

        // --- GEMINI API ---
        async function callGemini(prompt) {
            if (!geminiApiKey || geminiApiKey === "AIzaSyCV3bEJGDZOg2LHdfDusA_pdHm9dcxavpk") {
                showToast("AI features not configured", "error");
                return null;
            }
            
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-pro:generateContent?key=${geminiApiKey}`;
            
            try {
                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        contents: [{
                            role: "user",
                            parts: [{ text: prompt }]
                        }]
                    })
                });
                
                if (!response.ok) throw new Error(`API Error: ${response.statusText}`);
                
                const result = await response.json();
                if (result.candidates?.[0]?.content?.parts?.[0]?.text) {
                    return result.candidates[0].content.parts[0].text.replace(/```json\s*|\s*```/g, '').trim();
                } else {
                    throw new Error("Invalid response from AI");
                }
            } catch (error) {
                console.error("Gemini API error:", error);
                showToast("AI feature temporarily unavailable", "error");
                return null;
            }
        }

        // --- CORE FEATURES ---

        // Feed
        function loadFeed() {
            const container = document.getElementById('feed-posts');
            const q = query(collection(db, `artifacts/${appId}/public/data/feed`), orderBy('timestamp', 'desc'), limit(20));
            
            const unsubscribe = onSnapshot(q, (snapshot) => {
                if (snapshot.empty) {
                    container.innerHTML = `
                        <div class="text-center text-stone-500 py-10">
                            <i class="fas fa-comments text-4xl mb-3 opacity-50"></i>
                            <p>No posts yet. Be the first to share!</p>
                        </div>
                    `;
                } else {
                    container.innerHTML = snapshot.docs.map(doc => {
                        const post = doc.data();
                        const time = post.timestamp?.toDate();
                        const timeStr = time ? formatRelativeTime(time) : 'Just now';
                        
                        return `
                            <div class="wedding-card">
                                <div class="flex items-start">
                                    <div class="w-10 h-10 rounded-full bg-gradient-to-br from-emerald-400 to-pink-400 flex items-center justify-center font-bold text-white mr-3 flex-shrink-0">
                                        ${post.authorName.charAt(0).toUpperCase()}
                                    </div>
                                    <div class="flex-1">
                                        <div class="flex items-baseline justify-between mb-2">
                                            <p class="font-bold text-stone-800 dark:text-stone-200">${post.authorName}</p>
                                            <p class="text-xs text-stone-500">${timeStr}</p>
                                        </div>
                                        <p class="text-stone-700 dark:text-stone-300 whitespace-pre-wrap">${post.text}</p>
                                        <div class="mt-3 flex items-center space-x-4 text-sm">
                                            <button onclick="likePost('${doc.id}')" class="text-stone-500 hover:text-pink-600 transition">
                                                <i class="fas fa-heart ${post.likes?.includes(currentUser.uid) ? 'text-pink-600' : ''}"></i>
                                                <span class="ml-1">${post.likeCount || 0}</span>
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        `;
                    }).join('');
                }
            });
            
            currentUnsubscribes.push(unsubscribe);
        }

        window.likePost = async (postId) => {
            const postRef = doc(db, `artifacts/${appId}/public/data/feed/${postId}`);
            const postDoc = await getDoc(postRef);
            const postData = postDoc.data();
            const likes = postData.likes || [];
            
            if (likes.includes(currentUser.uid)) {
                // Unlike
                await updateDoc(postRef, {
                    likes: likes.filter(uid => uid !== currentUser.uid),
                    likeCount: increment(-1)
                });
            } else {
                // Like
                likes.push(currentUser.uid);
                await updateDoc(postRef, {
                    likes: likes,
                    likeCount: increment(1)
                });
            }
        }

        // Post submission
        document.getElementById('submit-post-button').addEventListener('click', async () => {
            const input = document.getElementById('post-text-input');
            const text = input.value.trim();
            
            if (!text) {
                showToast("Please write something first", "error");
                return;
            }
            
            try {
                await addDoc(collection(db, `artifacts/${appId}/public/data/feed`), {
                    authorId: currentUser.uid,
                    authorName: currentUser.displayName,
                    text: text,
                    timestamp: serverTimestamp(),
                    likes: [],
                    likeCount: 0
                });
                
                await updateDoc(doc(db, `artifacts/${appId}/public/data/users/${currentUser.uid}`), {
                    postCount: increment(1)
                });
                
                await updateUserPoints(5);
                checkAchievements();
                
                input.value = '';
                closeModal('post-modal');
                showToast("Posted successfully! +5 points");
            } catch (error) {
                console.error("Error posting:", error);
                showToast("Failed to post. Please try again.", "error");
            }
        });

        // AI post suggestion
        document.getElementById('suggest-post-button').addEventListener('click', async (e) => {
            const btn = e.currentTarget;
            btn.disabled = true;
            btn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i> Thinking...';
            
            const suggestion = await callGemini(
                "Write a fun, heartfelt, or humorous social media post for a wedding guest to share about Jaycee and Emily's wedding. " +
                "Keep it short, genuine, and appropriate. Vary between different styles: excited, nostalgic, funny, or romantic."
            );
            
            if (suggestion) {
                document.getElementById('post-text-input').value = suggestion.replace(/"/g, '');
            }
            
            btn.disabled = false;
            btn.innerHTML = '<span class="mr-2">✨</span> AI Suggest';
        });

        // Schedule
        const scheduleData = [
            {
                date: 'Friday, July 25, 2025',
                events: [
                    { time: '3:00 PM', title: 'Hotel Check-in Opens', description: 'Get settled in your rooms', category: 'reunion', icon: '🏨' },
                    { time: '6:00 PM', title: 'Welcome Beach BBQ', description: 'Casual dinner to kick off the weekend!', category: 'reunion', icon: '🍖', location: 'Resort Beach Pavilion' }
                ]
            },
            {
                date: 'Saturday, July 26, 2025',
                events: [
                    { time: '10:00 AM', title: 'Beach Volleyball Tournament', description: 'Show off your skills!', category: 'reunion', icon: '🏐', location: 'Resort Beach' },
                    { time: '12:00 PM', title: 'Lunch & Pool Party', description: 'Food, drinks, and fun in the sun', category: 'reunion', icon: '🏊' },
                    { time: '3:00 PM', title: 'Spa Time', description: 'Optional spa treatments (book in advance)', category: 'reunion', icon: '💆' },
                    { time: '5:00 PM', title: 'Rehearsal', description: 'Wedding party only', category: 'wedding', icon: '💒' },
                    { time: '7:00 PM', title: 'Rehearsal Dinner', description: 'For wedding party and immediate family', category: 'wedding', icon: '🍽️', location: 'The Ocean Room' }
                ]
            },
            {
                date: 'Sunday, July 27, 2025 - Wedding Day! 💕',
                events: [
                    { time: '10:00 AM', title: 'Bridal Party Prep', description: 'Hair, makeup, and mimosas!', category: 'wedding', icon: '💄' },
                    { time: '3:30 PM', title: 'Guest Arrival', description: 'Please be seated by 3:45 PM', category: 'wedding', icon: '🪑' },
                    { time: '4:00 PM', title: 'Wedding Ceremony', description: 'The moment we\'ve been waiting for!', category: 'wedding', icon: '💍', location: 'Oceanfront Garden' },
                    { time: '5:00 PM', title: 'Cocktail Hour', description: 'Drinks and appetizers', category: 'wedding', icon: '🍹', location: 'Sunset Terrace' },
                    { time: '6:30 PM', title: 'Reception', description: 'Dinner, dancing, and celebration!', category: 'wedding', icon: '🎉', location: 'Grand Ballroom' },
                    { time: '11:00 PM', title: 'After Party', description: 'Keep the party going!', category: 'wedding', icon: '🕺', location: 'Beach Bar' }
                ]
            },
            {
                date: 'Monday, July 28, 2025',
                events: [
                    { time: '10:00 AM', title: 'Farewell Brunch', description: 'One last meal together', category: 'reunion', icon: '🥞', location: 'Resort Restaurant' },
                    { time: '12:00 PM', title: 'Hotel Checkout', description: 'Safe travels home!', category: 'reunion', icon: '👋' }
                ]
            }
        ];

        function loadSchedule() {
            filterSchedule('all');
        }

        window.filterSchedule = (filter, btn) => {
            const container = document.getElementById('schedule-list');
            
            // Update button states
            if (btn) {
                document.querySelectorAll('.schedule-tab').forEach(b => {
                    b.classList.remove('bg-emerald-600', 'text-white');
                    b.classList.add('bg-stone-200', 'text-stone-700');
                });
                btn.classList.remove('bg-stone-200', 'text-stone-700');
                btn.classList.add('bg-emerald-600', 'text-white');
            }
            
            // Render schedule
            container.innerHTML = scheduleData.map(day => {
                const filteredEvents = filter === 'all' 
                    ? day.events 
                    : day.events.filter(e => e.category === filter);
                
                if (filteredEvents.length === 0) return '';
                
                return `
                    <div class="mb-8">
                        <h3 class="text-xl font-bold mb-4 text-stone-800 dark:text-stone-200">
                            ${day.date}
                        </h3>
                        <div class="space-y-3">
                            ${filteredEvents.map(event => `
                                <div class="wedding-card flex items-start">
                                    <div class="text-3xl mr-4 mt-1">${event.icon}</div>
                                    <div class="flex-1">
                                        <div class="flex items-start justify-between">
                                            <div>
                                                <h4 class="font-bold text-lg">${event.title}</h4>
                                                <p class="text-emerald-600 font-semibold">${event.time}</p>
                                                ${event.location ? `<p class="text-sm text-stone-600 dark:text-stone-400">📍 ${event.location}</p>` : ''}
                                                <p class="text-stone-600 dark:text-stone-400 mt-1">${event.description}</p>
                                            </div>
                                            ${event.location ? `
                                                <button onclick="getDirections('${event.location}')" class="ml-4 p-2 bg-emerald-100 dark:bg-emerald-900 text-emerald-700 dark:text-emerald-300 rounded-lg hover:bg-emerald-200 dark:hover:bg-emerald-800 transition">
                                                    <i class="fas fa-map-marker-alt"></i>
                                                </button>
                                            ` : ''}
                                        </div>
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                `;
            }).join('');
        }

        window.getDirections = (location) => {
            const fullLocation = location.includes('Myrtle Beach') ? location : `${location}, Myrtle Beach, SC`;
            window.open(`https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(fullLocation)}`, '_blank');
        }

        // Photos
        function loadPhotos() {
            const container = document.getElementById('photo-grid');
            const q = query(collection(db, `artifacts/${appId}/public/data/photos`), orderBy('timestamp', 'desc'));
            
            const unsubscribe = onSnapshot(q, (snapshot) => {
                lightboxPhotos = [];
                
                if (snapshot.empty) {
                    container.innerHTML = `
                        <div class="col-span-full text-center text-stone-500 py-20">
                            <i class="fas fa-camera text-5xl mb-4 opacity-50"></i>
                            <p>No photos yet. Be the first to capture a moment!</p>
                        </div>
                    `;
                } else {
                    container.innerHTML = snapshot.docs.map((doc, index) => {
                        const photo = doc.data();
                        lightboxPhotos.push(photo);
                        
                        return `
                            <div class="photo-item" onclick="openLightbox(${index})">
                                <img src="${photo.imageUrl}" 
                                     alt="${photo.caption || 'Wedding photo'}" 
                                     onerror="this.onerror=null;this.src='data:image/svg+xml,%3Csvg xmlns=\\'http://www.w3.org/2000/svg\\' width=\\'400\\' height=\\'400\\' viewBox=\\'0 0 400 400\\'%3E%3Crect width=\\'400\\' height=\\'400\\' fill=\\'%23f3f4f6\\'/%3E%3Ctext x=\\'50%25\\' y=\\'50%25\\' text-anchor=\\'middle\\' dy=\\'.3em\\' font-family=\\'sans-serif\\' font-size=\\'16\\' fill=\\'%236b7280\\'%3EImage Loading...%3C/text%3E%3C/svg%3E'">
                                <div class="photo-overlay">
                                    <p class="font-semibold">${photo.caption || 'Untitled'}</p>
                                    <p class="text-sm">by ${photo.uploaderName}</p>
                                </div>
                            </div>
                        `;
                    }).join('');
                }
            });
            
            currentUnsubscribes.push(unsubscribe);
        }

        window.openLightbox = (index) => {
            currentLightboxIndex = index;
            const photo = lightboxPhotos[index];
            document.getElementById('lightbox-image').src = photo.imageUrl;
            document.getElementById('lightbox-caption').textContent = photo.caption || '';
            document.getElementById('lightbox-author').textContent = `Photo by ${photo.uploaderName}`;
            document.getElementById('photo-lightbox').classList.remove('hidden');
        }

        window.closeLightbox = () => {
            document.getElementById('photo-lightbox').classList.add('hidden');
        }

        window.previousPhoto = () => {
            currentLightboxIndex = (currentLightboxIndex - 1 + lightboxPhotos.length) % lightboxPhotos.length;
            openLightbox(currentLightboxIndex);
        }

        window.nextPhoto = () => {
            currentLightboxIndex = (currentLightboxIndex + 1) % lightboxPhotos.length;
            openLightbox(currentLightboxIndex);
        }

        window.filterPhotos = (category) => {
            // This would filter photos by category if implemented
            showToast("Filter coming soon!");
        }

        // Photo upload
        document.getElementById('photo-file-input').addEventListener('change', (e) => {
            const file = e.target.files[0];
            if (file) {
                document.getElementById('file-chosen-text').textContent = file.name;
                document.getElementById('submit-photo-button').disabled = false;
            }
        });

        document.getElementById('submit-photo-button').addEventListener('click', async () => {
            const file = document.getElementById('photo-file-input').files[0];
            if (!file) return;

            const caption = document.getElementById('photo-caption-input').value.trim();
            const category = document.getElementById('photo-category').value;
            const btn = document.getElementById('submit-photo-button');
            const progressContainer = document.getElementById('upload-progress-container');
            const progressBar = document.getElementById('upload-progress-bar');
            
            btn.disabled = true;
            btn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i> Uploading...';
            progressContainer.classList.remove('hidden');

            try {
                const storageRef = ref(storage, `${appId}/photos/${currentUser.uid}/${Date.now()}-${file.name}`);
                const uploadTask = uploadBytesResumable(storageRef, file);

                uploadTask.on('state_changed', 
                    (snapshot) => {
                        const progress = (snapshot.bytesTransferred / snapshot.totalBytes) * 100;
                        progressBar.style.width = progress + '%';
                    },
                    (error) => {
                        console.error("Upload failed:", error);
                        showToast("Upload failed. Please try again.", "error");
                        resetPhotoModal();
                    }, 
                    async () => {
                        const downloadURL = await getDownloadURL(uploadTask.snapshot.ref);
                        
                        await addDoc(collection(db, `artifacts/${appId}/public/data/photos`), {
                            uploaderId: currentUser.uid,
                            uploaderName: currentUser.displayName,
                            imageUrl: downloadURL,
                            caption: caption,
                            category: category,
                            timestamp: serverTimestamp(),
                            likes: [],
                            likeCount: 0
                        });
                        
                        await updateDoc(doc(db, `artifacts/${appId}/public/data/users/${currentUser.uid}`), {
                            photoCount: increment(1)
                        });
                        
                        await updateUserPoints(10);
                        checkAchievements();
                        
                        closeModal('photo-modal');
                        resetPhotoModal();
                        showToast("Photo uploaded! +10 points");
                    }
                );
            } catch (error) {
                console.error("Error uploading photo:", error);
                showToast("Failed to upload photo.", "error");
                resetPhotoModal();
            }
        });

        function resetPhotoModal() {
            document.getElementById('photo-file-input').value = '';
            document.getElementById('photo-caption-input').value = '';
            document.getElementById('file-chosen-text').textContent = 'Click to choose a photo';
            document.getElementById('submit-photo-button').disabled = true;
            document.getElementById('submit-photo-button').innerHTML = 'Upload Photo';
            document.getElementById('upload-progress-container').classList.add('hidden');
            document.getElementById('upload-progress-bar').style.width = '0%';
        }

        // Photo Booth
        async function initPhotoBoooth() {
            try {
                const video = document.getElementById('photo-booth-video');
                photoBoothStream = await navigator.mediaDevices.getUserMedia({ video: true });
                video.srcObject = photoBoothStream;
            } catch (error) {
                console.error("Camera access error:", error);
                showToast("Camera access denied", "error");
            }
        }

        window.setPhotoFilter = (filter) => {
            currentPhotoFilter = filter;
            document.querySelectorAll('.filter-option').forEach(opt => opt.classList.remove('active'));
            event.target.closest('.filter-option').classList.add('active');
        }

        window.capturePhoto = () => {
            const video = document.getElementById('photo-booth-video');
            const canvas = document.getElementById('photo-booth-canvas');
            const ctx = canvas.getContext('2d');
            
            canvas.width = video.videoWidth;
            canvas.height = video.videoHeight;
            ctx.drawImage(video, 0, 0);
            
            // Apply filter effects here if needed
            
            const preview = document.getElementById('photo-booth-preview');
            preview.innerHTML = `<img src="${canvas.toDataURL()}" class="w-full rounded-lg">`;
            preview.classList.remove('hidden');
            video.classList.add('hidden');
            
            document.getElementById('capture-photo-btn').classList.add('hidden');
            document.getElementById('save-photo-btn').classList.remove('hidden');
        }

        window.saveBoothPhoto = async () => {
            const canvas = document.getElementById('photo-booth-canvas');
            canvas.toBlob(async (blob) => {
                const file = new File([blob], `photobooth-${Date.now()}.jpg`, { type: 'image/jpeg' });
                
                // Upload the photo
                const storageRef = ref(storage, `${appId}/photos/${currentUser.uid}/booth-${Date.now()}.jpg`);
                const uploadTask = await uploadBytesResumable(storageRef, file);
                const downloadURL = await getDownloadURL(uploadTask.ref);
                
                await addDoc(collection(db, `artifacts/${appId}/public/data/photos`), {
                    uploaderId: currentUser.uid,
                    uploaderName: currentUser.displayName,
                    imageUrl: downloadURL,
                    caption: `Photo booth fun! 📸`,
                    category: 'booth',
                    timestamp: serverTimestamp()
                });
                
                showToast("Photo saved! +10 points");
                await updateUserPoints(10);
                closeModal('photo-booth-modal');
            });
        }

        // AI Highlight Reel
        document.getElementById('generate-highlight-button').addEventListener('click', async (e) => {
            const btn = e.currentTarget;
            btn.disabled = true;
            btn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i> Generating...';
            
            openModal('highlight-modal');
            const contentDiv = document.getElementById('highlight-content');
            contentDiv.innerHTML = '<div class="text-center py-8"><div class="spinner mx-auto mb-4"></div><p>Creating your personalized highlight reel...</p></div>';
            
            try {
                const [photosSnap, feedSnap, guestbookSnap] = await Promise.all([
                    getDocs(query(collection(db, `artifacts/${appId}/public/data/photos`), limit(10))),
                    getDocs(query(collection(db, `artifacts/${appId}/public/data/feed`), limit(10))),
                    getDocs(query(collection(db, `artifacts/${appId}/public/data/guestbook`), limit(10)))
                ]);

                const memories = [
                    ...photosSnap.docs.map(d => `Photo: "${d.data().caption || 'Beautiful moment'}" by ${d.data().uploaderName}`),
                    ...feedSnap.docs.map(d => `Post: "${d.data().text}" by ${d.data().authorName}`),
                    ...guestbookSnap.docs.map(d => d.data().type === 'text' ? `Message: "${d.data().message}" from ${d.data().authorName}` : null).filter(Boolean)
                ];

                if (memories.length < 3) {
                    contentDiv.innerHTML = `
                        <div class="text-center py-8">
                            <i class="fas fa-photo-video text-5xl text-stone-400 mb-4"></i>
                            <p>Not enough content yet! Keep sharing photos, posts, and messages to generate your highlight reel.</p>
                        </div>
                    `;
                    btn.disabled = false;
                    btn.innerHTML = '<span class="mr-2">✨</span> AI Highlights';
                    return;
                }

                const prompt = `Create a beautiful, emotional wedding highlight reel narrative for Jaycee and Emily's wedding based on these guest contributions. 
                Write it as a touching story that captures the joy, love, and special moments. Format with a romantic title and 3-4 short, meaningful paragraphs.
                Include specific details from: ${memories.join('; ')}`;
                
                const story = await callGemini(prompt);
                
                if (story) {
                    contentDiv.innerHTML = `
                        <div class="prose prose-stone dark:prose-invert max-w-none">
                            ${story.split('\n').map(line => {
                                if (line.startsWith('#')) {
                                    return `<h3 class="text-2xl font-script text-pink-600 mb-4">${line.replace(/#/g, '')}</h3>`;
                                } else if (line.trim()) {
                                    return `<p class="mb-4 leading-relaxed">${line}</p>`;
                                }
                                return '';
                            }).join('')}
                        </div>
                        <div class="mt-6 text-center">
                            <button onclick="shareHighlight()" class="btn-primary">
                                <i class="fas fa-share mr-2"></i> Share This Story
                            </button>
                        </div>
                    `;
                } else {
                    contentDiv.innerHTML = '<p class="text-center">Could not generate story. Please try again.</p>';
                }
            } catch (error) {
                console.error("Error generating highlights:", error);
                contentDiv.innerHTML = '<p class="text-center text-red-600">Failed to generate highlights. Please try again.</p>';
            }
            
            btn.disabled = false;
            btn.innerHTML = '<span class="mr-2">✨</span> AI Highlights';
        });

        window.shareHighlight = () => {
            showToast("Sharing feature coming soon!");
        }

        // Guestbook
        function loadGuestbook() {
            const container = document.getElementById('guestbook-messages');
            const q = query(collection(db, `artifacts/${appId}/public/data/guestbook`), orderBy('timestamp', 'desc'));
            
            const unsubscribe = onSnapshot(q, (snapshot) => {
                if (snapshot.empty) {
                    container.innerHTML = `
                        <div class="text-center text-stone-500 py-10">
                            <i class="fas fa-book-heart text-4xl mb-3 opacity-50"></i>
                            <p>No messages yet. Be the first to leave one!</p>
                        </div>
                    `;
                } else {
                    container.innerHTML = snapshot.docs.map(doc => {
                        const msg = doc.data();
                        const time = msg.timestamp?.toDate();
                        const timeStr = time ? formatRelativeTime(time) : 'Just now';
                        
                        if (msg.type === 'text') {
                            return `
                                <div class="wedding-card">
                                    <div class="flex items-start">
                                        <div class="w-10 h-10 rounded-full bg-gradient-to-br from-pink-400 to-purple-400 flex items-center justify-center font-bold text-white mr-3 flex-shrink-0">
                                            ${msg.authorName.charAt(0).toUpperCase()}
                                        </div>
                                        <div class="flex-1">
                                            <div class="flex items-baseline justify-between mb-2">
                                                <p class="font-bold">${msg.authorName}</p>
                                                <p class="text-xs text-stone-500">${timeStr}</p>
                                            </div>
                                            <p class="italic text-stone-700 dark:text-stone-300">"${msg.message}"</p>
                                        </div>
                                    </div>
                                </div>
                            `;
                        } else if (msg.type === 'audio') {
                            return `
                                <div class="wedding-card">
                                    <div class="flex items-start">
                                        <div class="w-10 h-10 rounded-full bg-gradient-to-br from-blue-400 to-cyan-400 flex items-center justify-center text-white mr-3 flex-shrink-0">
                                            <i class="fas fa-microphone"></i>
                                        </div>
                                        <div class="flex-1">
                                            <div class="flex items-baseline justify-between mb-2">
                                                <p class="font-bold">Audio message from ${msg.authorName}</p>
                                                <p class="text-xs text-stone-500">${timeStr}</p>
                                            </div>
                                            <audio controls class="w-full mt-2" src="${msg.audioUrl}"></audio>
                                        </div>
                                    </div>
                                </div>
                            `;
                        } else if (msg.type === 'video') {
                            return `
                                <div class="wedding-card">
                                    <div class="flex items-start">
                                        <div class="w-10 h-10 rounded-full bg-gradient-to-br from-purple-400 to-pink-400 flex items-center justify-center text-white mr-3 flex-shrink-0">
                                            <i class="fas fa-video"></i>
                                        </div>
                                        <div class="flex-1">
                                            <div class="flex items-baseline justify-between mb-2">
                                                <p class="font-bold">Video toast from ${msg.authorName}</p>
                                                <p class="text-xs text-stone-500">${timeStr}</p>
                                            </div>
                                            <video controls class="w-full mt-2 rounded-lg" src="${msg.videoUrl}"></video>
                                        </div>
                                    </div>
                                </div>
                            `;
                        }
                        return '';
                    }).join('');
                }
            });
            
            currentUnsubscribes.push(unsubscribe);
        }

        window.filterGuestbook = (type) => {
            // This would filter messages by type if implemented
            showToast("Filter coming soon!");
        }

        window.openGuestbookModal = (type) => {
            document.querySelectorAll('.message-form').forEach(f => f.classList.add('hidden'));
            document.getElementById(`${type}-message-form`).classList.remove('hidden');
            openModal('guestbook-input-modal');
            
            if (type === 'video') {
                initVideoRecording();
            }
        }

        // Text message submission
        document.getElementById('submit-text-message').addEventListener('click', async () => {
            const input = document.getElementById('guestbook-text-input');
            const message = input.value.trim();
            
            if (!message) {
                showToast("Please write a message first", "error");
                return;
            }
            
            try {
                await addDoc(collection(db, `artifacts/${appId}/public/data/guestbook`), {
                    authorId: currentUser.uid,
                    authorName: currentUser.displayName,
                    message: message,
                    type: 'text',
                    timestamp: serverTimestamp()
                });
                
                await updateUserPoints(15, 'memory_keeper');
                
                input.value = '';
                closeModal('guestbook-input-modal');
                showToast("Message saved! +15 points");
            } catch (error) {
                console.error("Error saving message:", error);
                showToast("Failed to save message", "error");
            }
        });

        // AI message suggestion
        document.getElementById('suggest-message-button').addEventListener('click', async (e) => {
            const btn = e.currentTarget;
            btn.disabled = true;
            btn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i> Thinking...';
            
            const suggestion = await callGemini(
                "Write a heartfelt, warm, or funny guestbook message for Jaycee and Emily's wedding. " +
                "Make it personal and genuine, as if from a close friend or family member. " +
                "Vary the style: sometimes nostalgic, sometimes advice-giving, sometimes humorous."
            );
            
            if (suggestion) {
                document.getElementById('guestbook-text-input').value = suggestion.replace(/"/g, '');
            }
            
            btn.disabled = false;
            btn.innerHTML = '<span class="mr-2">✨</span> AI Suggest';
        });

        // Audio recording
        const recordButton = document.getElementById('record-audio-button');
        const recordStatus = document.getElementById('record-status');
        let isRecording = false;
        
        const startRecording = async () => {
            try {
                const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                mediaRecorder = new MediaRecorder(stream);
                audioChunks = [];
                
                mediaRecorder.addEventListener("dataavailable", e => audioChunks.push(e.data));
                mediaRecorder.start();
                
                isRecording = true;
                recordStatus.textContent = "Recording... Release to stop";
                recordButton.classList.add('animate-pulse', 'scale-110');
                document.getElementById('audio-waveform').classList.remove('hidden');
            } catch (error) {
                console.error("Microphone access error:", error);
                showToast("Microphone access denied", "error");
            }
        };
        
        const stopRecording = () => {
            if (!mediaRecorder || !isRecording) return;
            
            isRecording = false;
            mediaRecorder.stop();
            mediaRecorder.stream.getTracks().forEach(track => track.stop());
            
            recordStatus.textContent = "Processing...";
            recordButton.classList.remove('animate-pulse', 'scale-110');
            
            mediaRecorder.addEventListener("stop", async () => {
                const audioBlob = new Blob(audioChunks, { type: 'audio/webm' });
                
                try {
                    const storageRef = ref(storage, `${appId}/audio/${currentUser.uid}/${Date.now()}.webm`);
                    const uploadTask = uploadBytesResumable(storageRef, audioBlob);
                    
                    recordStatus.textContent = "Uploading...";
                    
                    uploadTask.on('state_changed', null, 
                        (err) => {
                            console.error("Audio upload error:", err);
                            showToast("Upload failed", "error");
                            recordStatus.textContent = "";
                        },
                        async () => {
                            const downloadURL = await getDownloadURL(uploadTask.snapshot.ref);
                            
                            await addDoc(collection(db, `artifacts/${appId}/public/data/guestbook`), {
                                authorId: currentUser.uid,
                                authorName: currentUser.displayName,
                                audioUrl: downloadURL,
                                type: 'audio',
                                timestamp: serverTimestamp()
                            });
                            
                            await updateUserPoints(20);
                            recordStatus.textContent = "Saved! 🎉";
                            document.getElementById('audio-waveform').classList.add('hidden');
                            
                            setTimeout(() => {
                                closeModal('guestbook-input-modal');
                                recordStatus.textContent = "";
                            }, 1500);
                        }
                    );
                } catch (error) {
                    console.error("Error saving audio:", error);
                    showToast("Failed to save audio", "error");
                    recordStatus.textContent = "";
                }
            });
        };
        
        recordButton.addEventListener('mousedown', startRecording);
        recordButton.addEventListener('mouseup', stopRecording);
        recordButton.addEventListener('touchstart', startRecording, { passive: true });
        recordButton.addEventListener('touchend', stopRecording);
        recordButton.addEventListener('mouseleave', () => {
            if (isRecording) stopRecording();
        });

        // Video recording
        let videoStream = null;
        let videoRecorder = null;
        let videoChunks = [];
        
        async function initVideoRecording() {
            try {
                const video = document.getElementById('video-preview');
                videoStream = await navigator.mediaDevices.getUserMedia({ video: true, audio: true });
                video.srcObject = videoStream;
                video.classList.remove('hidden');
            } catch (error) {
                console.error("Camera access error:", error);
                showToast("Camera access denied", "error");
            }
        }
        
        document.getElementById('record-video-button').addEventListener('click', async () => {
            const btn = document.getElementById('record-video-button');
            const status = document.getElementById('video-status');
            
            if (!videoRecorder || videoRecorder.state === 'inactive') {
                // Start recording
                videoChunks = [];
                videoRecorder = new MediaRecorder(videoStream);
                
                videoRecorder.addEventListener('dataavailable', e => videoChunks.push(e.data));
                videoRecorder.addEventListener('stop', async () => {
                    const videoBlob = new Blob(videoChunks, { type: 'video/webm' });
                    
                    try {
                        status.textContent = "Uploading video...";
                        const storageRef = ref(storage, `${appId}/videos/${currentUser.uid}/${Date.now()}.webm`);
                        const uploadTask = uploadBytesResumable(storageRef, videoBlob);
                        
                        const downloadURL = await getDownloadURL((await uploadTask).ref);
                        
                        await addDoc(collection(db, `artifacts/${appId}/public/data/guestbook`), {
                            authorId: currentUser.uid,
                            authorName: currentUser.displayName,
                            videoUrl: downloadURL,
                            type: 'video',
                            timestamp: serverTimestamp()
                        });
                        
                        await updateUserPoints(25);
                        showToast("Video toast saved! +25 points");
                        closeModal('guestbook-input-modal');
                        
                        // Cleanup
                        if (videoStream) {
                            videoStream.getTracks().forEach(track => track.stop());
                            videoStream = null;
                        }
                    } catch (error) {
                        console.error("Error saving video:", error);
                        showToast("Failed to save video", "error");
                    }
                });
                
                videoRecorder.start();
                btn.innerHTML = '<i class="fas fa-stop text-3xl"></i>';
                btn.classList.add('bg-red-700');
                status.textContent = "Recording... Click to stop";
            } else {
                // Stop recording
                videoRecorder.stop();
                btn.innerHTML = '<i class="fas fa-video text-3xl"></i>';
                btn.classList.remove('bg-red-700');
                status.textContent = "Processing...";
            }
        });

        // Local Guide
        const guideData = [
            {
                name: "The Bowery",
                category: ["favorites", "dining", "romantic"],
                description: "Where Jaycee proposed! Amazing steaks and ocean views.",
                icon: "🥩",
                rating: "⭐⭐⭐⭐⭐",
                tip: "Request the corner table for the best sunset view"
            },
            {
                name: "Broadway at the Beach",
                category: ["activities", "groups"],
                description: "Entertainment complex with shows, dining, and shopping",
                icon: "🎭",
                rating: "⭐⭐⭐⭐",
                tip: "Check out the fireworks on Wednesday nights!"
            },
            {
                name: "Myrtle Beach SkyWheel",
                category: ["favorites", "activities", "romantic"],
                description: "200-foot tall Ferris wheel with amazing views",
                icon: "🎡",
                rating: "⭐⭐⭐⭐⭐",
                tip: "Go at sunset for breathtaking photos"
            },
            {
                name: "Sea Captain's House",
                category: ["dining", "favorites"],
                description: "Oceanfront dining with incredible seafood",
                icon: "🦐",
                rating: "⭐⭐⭐⭐⭐",
                tip: "Try the she-crab soup - it's legendary!"
            },
            {
                name: "Brookgreen Gardens",
                category: ["activities", "romantic"],
                description: "Beautiful sculpture gardens and nature preserve",
                icon: "🌺",
                rating: "⭐⭐⭐⭐⭐",
                tip: "Perfect for a romantic stroll"
            },
            {
                name: "Pier 14",
                category: ["dining", "activities"],
                description: "Restaurant and fishing pier",
                icon: "🎣",
                rating: "⭐⭐⭐⭐",
                tip: "Great for drinks and watching surfers"
            }
        ];

        function loadGuide(filter) {
            filterGuide(filter);
        }

        window.filterGuide = (filter, btn) => {
            const container = document.getElementById('guide-grid');
            
            // Update button states
            if (btn) {
                document.querySelectorAll('.guide-filter').forEach(b => {
                    b.classList.remove('bg-emerald-600', 'text-white');
                    b.classList.add('bg-stone-200', 'text-stone-700');
                });
                btn.classList.remove('bg-stone-200', 'text-stone-700');
                btn.classList.add('bg-emerald-600', 'text-white');
            }
            
            const filtered = filter === 'all' 
                ? guideData 
                : guideData.filter(place => place.category.includes(filter));
            
            container.innerHTML = filtered.map(place => `
                <div class="wedding-card hover:scale-105 transition cursor-pointer" onclick="getDirections('${place.name}, Myrtle Beach, SC')">
                    <div class="text-4xl mb-3">${place.icon}</div>
                    <h3 class="text-xl font-bold mb-2">${place.name}</h3>
                    <p class="text-sm text-stone-600 dark:text-stone-400 mb-3">${place.description}</p>
                    <div class="flex items-center justify-between mb-3">
                        <span>${place.rating}</span>
                        <span class="text-xs bg-emerald-100 dark:bg-emerald-900 text-emerald-700 dark:text-emerald-300 px-2 py-1 rounded-full">
                            ${place.category[0]}
                        </span>
                    </div>
                    <p class="text-sm italic text-stone-500">💡 ${place.tip}</p>
                </div>
            `).join('');
        }

        // Guest Directory
        let allGuests = [];
        
        async function loadGuestList() {
            const snapshot = await getDocs(collection(db, `artifacts/${appId}/public/data/users`));
            allGuests = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }))
                .sort((a, b) => a.displayName.localeCompare(b.displayName));
        }
        
        function renderGuestList(searchTerm = '') {
            const container = document.getElementById('guest-list');
            const filtered = searchTerm 
                ? allGuests.filter(g => 
                    g.displayName.toLowerCase().includes(searchTerm.toLowerCase()) ||
                    g.relationship.toLowerCase().includes(searchTerm.toLowerCase())
                  )
                : allGuests;
            
            container.innerHTML = filtered.map(guest => `
                <div class="wedding-card">
                    <div class="flex items-center">
                        <div class="w-12 h-12 rounded-full bg-gradient-to-br from-emerald-400 to-blue-400 flex items-center justify-center font-bold text-white text-lg mr-3">
                            ${guest.displayName.charAt(0).toUpperCase()}
                        </div>
                        <div>
                            <p class="font-bold">${guest.displayName}</p>
                            <p class="text-sm text-stone-600 dark:text-stone-400">${guest.relationship}</p>
                            ${guest.tableNumber ? `<p class="text-xs text-emerald-600">Table ${guest.tableNumber}</p>` : ''}
                        </div>
                    </div>
                </div>
            `).join('');
        }
        
        document.getElementById('guest-search').addEventListener('input', (e) => {
            renderGuestList(e.target.value);
        });

        // RSVP
        async function loadRSVP() {
            const container = document.getElementById('rsvp-status');
            const userRef = doc(db, `artifacts/${appId}/public/data/users/${currentUser.uid}`);
            const userDoc = await getDoc(userRef);
            const userData = userDoc.data();
            
            if (userData.rsvpStatus) {
                container.innerHTML = `
                    <div class="bg-emerald-50 dark:bg-emerald-900/20 border border-emerald-200 dark:border-emerald-800 rounded-lg p-4">
                        <div class="flex items-center">
                            <i class="fas fa-check-circle text-emerald-600 text-2xl mr-3"></i>
                            <div>
                                <p class="font-bold text-emerald-800 dark:text-emerald-200">RSVP Confirmed</p>
                                <p class="text-sm text-emerald-600 dark:text-emerald-400">
                                    ${userData.rsvpStatus === 'yes' ? `Party of ${userData.guestCount || 1}` : 'Sorry you can\'t make it'}
                                </p>
                            </div>
                        </div>
                    </div>
                `;
                
                if (userData.rsvpStatus === 'yes') {
                    document.getElementById('rsvp-details').classList.remove('hidden');
                    document.getElementById('guest-count').value = userData.guestCount || 1;
                    document.getElementById('dietary-restrictions').value = userData.dietaryRestrictions || '';
                    document.getElementById('song-request').value = userData.songRequest || '';
                }
            } else {
                container.innerHTML = `
                    <div class="bg-yellow-50 dark:bg-yellow-900/20 border border-yellow-200 dark:border-yellow-800 rounded-lg p-4">
                        <div class="flex items-center">
                            <i class="fas fa-exclamation-circle text-yellow-600 text-2xl mr-3"></i>
                            <div>
                                <p class="font-bold text-yellow-800 dark:text-yellow-200">Please RSVP</p>
                                <p class="text-sm text-yellow-600 dark:text-yellow-400">Let us know if you can make it!</p>
                            </div>
                        </div>
                    </div>
                `;
            }
            
            // Load table assignment if available
            if (userData.tableNumber) {
                document.getElementById('table-assignment').innerHTML = `
                    <div class="text-6xl font-bold text-emerald-600 mb-2">Table ${userData.tableNumber}</div>
                    <p class="text-stone-600">You'll be seated with great company!</p>
                `;
            }
        }

        window.setAttending = (attending) => {
            document.querySelectorAll('.rsvp-option').forEach(opt => {
                opt.classList.remove('border-emerald-500', 'bg-emerald-50');
            });
            
            event.target.closest('.rsvp-option').classList.add('border-emerald-500', 'bg-emerald-50');
            
            if (attending) {
                document.getElementById('rsvp-details').classList.remove('hidden');
            } else {
                document.getElementById('rsvp-details').classList.add('hidden');
            }
            
            document.getElementById('rsvp-form').dataset.attending = attending;
        }

        document.getElementById('rsvp-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const attending = e.target.dataset.attending;
            if (attending === undefined) {
                showToast("Please select if you're attending", "error");
                return;
            }
            
            const updates = {
                rsvpStatus: attending === 'true' ? 'yes' : 'no',
                rsvpDate: serverTimestamp()
            };
            
            if (attending === 'true') {
                updates.guestCount = parseInt(document.getElementById('guest-count').value);
                updates.dietaryRestrictions = document.getElementById('dietary-restrictions').value.trim();
                updates.songRequest = document.getElementById('song-request').value.trim();
            }
            
            try {
                await updateDoc(doc(db, `artifacts/${appId}/public/data/users/${currentUser.uid}`), updates);
                showToast("RSVP updated successfully!");
                loadRSVP();
            } catch (error) {
                console.error("Error updating RSVP:", error);
                showToast("Failed to update RSVP", "error");
            }
        });

        // Music Requests
        async function loadMusicRequests() {
            const container = document.getElementById('song-list');
            const q = query(collection(db, `artifacts/${appId}/public/data/songs`), orderBy('voteCount', 'desc'), limit(20));
            
            const snapshot = await getDocs(q);
            
            if (snapshot.empty) {
                container.innerHTML = '<p class="text-center text-stone-500">No songs requested yet!</p>';
            } else {
                const maxVotes = snapshot.docs[0].data().voteCount || 1;
                
                container.innerHTML = snapshot.docs.map(doc => {
                    const song = doc.data();
                    const votePercent = (song.voteCount / maxVotes) * 100;
                    const hasVoted = song.voters?.includes(currentUser.uid);
                    
                    return `
                        <div class="music-item">
                            <div class="flex-1">
                                <p class="font-semibold">${song.title}</p>
                                <p class="text-sm text-stone-600 dark:text-stone-400">${song.artist}</p>
                                <div class="vote-bar">
                                    <div class="vote-fill" style="width: ${votePercent}%"></div>
                                </div>
                            </div>
                            <button onclick="voteSong('${doc.id}')" class="ml-4 px-3 py-1 rounded-lg ${hasVoted ? 'bg-emerald-600 text-white' : 'bg-stone-200 text-stone-700'} transition">
                                <i class="fas fa-thumbs-up mr-1"></i>
                                ${song.voteCount || 0}
                            </button>
                        </div>
                    `;
                }).join('');
            }
        }

        window.requestSong = async () => {
            const input = document.getElementById('song-input');
            const value = input.value.trim();
            
            if (!value) {
                showToast("Please enter a song", "error");
                return;
            }
            
            const parts = value.split(' - ');
            const title = parts[0];
            const artist = parts[1] || 'Unknown Artist';
            
            try {
                // Check if song already exists
                const q = query(collection(db, `artifacts/${appId}/public/data/songs`), where('title', '==', title), where('artist', '==', artist));
                const existing = await getDocs(q);
                
                if (!existing.empty) {
                    showToast("This song has already been requested!", "error");
                    return;
                }
                
                await addDoc(collection(db, `artifacts/${appId}/public/data/songs`), {
                    title: title,
                    artist: artist,
                    requestedBy: currentUser.displayName,
                    requesterId: currentUser.uid,
                    voteCount: 1,
                    voters: [currentUser.uid],
                    timestamp: serverTimestamp()
                });
                
                input.value = '';
                showToast("Song added to the playlist!");
                loadMusicRequests();
            } catch (error) {
                console.error("Error adding song:", error);
                showToast("Failed to add song", "error");
            }
        }

        window.voteSong = async (songId) => {
            const songRef = doc(db, `artifacts/${appId}/public/data/songs/${songId}`);
            const songDoc = await getDoc(songRef);
            const songData = songDoc.data();
            const voters = songData.voters || [];
            
            if (voters.includes(currentUser.uid)) {
                // Remove vote
                await updateDoc(songRef, {
                    voters: voters.filter(uid => uid !== currentUser.uid),
                    voteCount: increment(-1)
                });
                showToast("Vote removed");
            } else {
                // Add vote
                voters.push(currentUser.uid);
                await updateDoc(songRef, {
                    voters: voters,
                    voteCount: increment(1)
                });
                showToast("Voted! +1");
                await updateUserPoints(1);
            }
            
            loadMusicRequests();
        }

        // Games
        function loadGames() {
            loadLeaderboard();
            renderAchievements();
        }

        async function loadLeaderboard() {
            const container = document.getElementById('leaderboard');
            const q = query(collection(db, `artifacts/${appId}/public/data/users`), orderBy('points', 'desc'), limit(10));
            const snapshot = await getDocs(q);
            
            if (snapshot.empty) {
                container.innerHTML = '<p class="text-center text-stone-500">No scores yet!</p>';
            } else {
                container.innerHTML = snapshot.docs.map((doc, i) => {
                    const user = doc.data();
                    const rank = i + 1;
                    const medal = rank === 1 ? '🥇' : rank === 2 ? '🥈' : rank === 3 ? '🥉' : `#${rank}`;
                    const isCurrentUser = doc.id === currentUser.uid;
                    
                    return `
                        <div class="flex items-center justify-between p-3 rounded-lg ${isCurrentUser ? 'bg-emerald-50 dark:bg-emerald-900/20 border-2 border-emerald-500' : 'bg-stone-50 dark:bg-stone-800'}">
                            <div class="flex items-center">
                                <span class="text-lg font-bold mr-3 w-8">${medal}</span>
                                <span class="${isCurrentUser ? 'font-bold' : ''}">${user.displayName}</span>
                            </div>
                            <span class="font-bold text-emerald-700 dark:text-emerald-400">${user.points || 0} pts</span>
                        </div>
                    `;
                }).join('');
            }
        }

        // Trivia Game
        let triviaQuestions = [];
        let currentQuestion = 0;
        let triviaScore = 0;
        
        window.startTrivia = async function() {
            currentQuestion = 0;
            triviaScore = 0;
            const container = document.getElementById('trivia-content');
            container.innerHTML = '<div class="text-center py-8"><div class="spinner mx-auto mb-4"></div><p>Loading trivia questions...</p></div>';
            
            await generateTrivia();
        }
        
        async function generateTrivia() {
            const prompt = `Generate 5 fun wedding trivia questions about a couple named Jaycee and Emily. 
            Return ONLY a valid JSON array with this structure: 
            [{"q": "question", "a": ["answer1", "answer2", "answer3", "answer4"], "correct": 0}]
            Make questions fun and wedding-themed. The correct field should be 0-3.`;
            
            const response = await callGemini(prompt);
            
            if (response) {
                try {
                    triviaQuestions = JSON.parse(response);
                    renderTriviaQuestion();
                } catch (error) {
                    console.error("Failed to parse trivia:", error);
                    // Fallback questions
                    triviaQuestions = [
                        { q: "What's the traditional gift for a 1st anniversary?", a: ["Paper", "Cotton", "Wood", "Silver"], correct: 0 },
                        { q: "Which month is the most popular for weddings?", a: ["May", "June", "August", "September"], correct: 1 },
                        { q: "What does 'RSVP' stand for?", a: ["Reply Soon Via Post", "Respond So Very Promptly", "Répondez s'il vous plaît", "Return Service Very Please"], correct: 2 }
                    ];
                    renderTriviaQuestion();
                }
            }
        }
        
        function renderTriviaQuestion() {
            const container = document.getElementById('trivia-content');
            
            if (currentQuestion >= triviaQuestions.length) {
                const perfect = triviaScore === triviaQuestions.length;
                container.innerHTML = `
                    <div class="text-center">
                        <div class="text-6xl mb-4">${perfect ? '🏆' : '🎉'}</div>
                        <h3 class="text-2xl font-bold mb-2">Quiz Complete!</h3>
                        <p class="text-xl mb-6">You scored ${triviaScore} out of ${triviaQuestions.length}!</p>
                        <p class="text-emerald-600 font-bold mb-6">+${triviaScore * 10} points earned!</p>
                        ${perfect ? '<p class="text-purple-600 font-bold mb-6">🎊 Perfect Score Achievement Unlocked!</p>' : ''}
                        <div class="flex justify-center space-x-4">
                            <button onclick="closeModal('trivia-modal')" class="px-4 py-2 rounded-lg bg-stone-500 text-white">
                                Close
                            </button>
                            <button onclick="startTrivia()" class="btn-primary">
                                Play Again
                            </button>
                        </div>
                    </div>
                `;
                
                updateUserPoints(triviaScore * 10, perfect ? 'trivia_master' : null);
                return;
            }
            
            const q = triviaQuestions[currentQuestion];
            container.innerHTML = `
                <div>
                    <div class="flex justify-between items-center mb-6">
                        <h3 class="text-2xl font-bold">Question ${currentQuestion + 1} of ${triviaQuestions.length}</h3>
                        <div class="text-sm">
                            <span class="text-emerald-600 font-bold">${triviaScore}</span> correct
                        </div>
                    </div>
                    <p class="text-lg mb-6">${q.q}</p>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
                        ${q.a.map((answer, i) => `
                            <button onclick="checkAnswer(${i}, ${q.correct})" 
                                    class="p-4 border-2 border-stone-300 rounded-lg hover:bg-emerald-50 hover:border-emerald-500 text-left transition">
                                ${answer}
                            </button>
                        `).join('')}
                    </div>
                </div>
            `;
        }
        
        window.checkAnswer = (selected, correct) => {
            if (selected === correct) {
                triviaScore++;
                showToast("Correct! 🎉");
            } else {
                showToast("Oops! Try the next one", "error");
            }
            currentQuestion++;
            setTimeout(() => renderTriviaQuestion(), 1000);
        }

        // Bingo Game
        const bingoItems = [
            "Take a selfie with the bride",
            "Dance to a slow song",
            "Sign the guestbook",
            "Try the wedding cake",
            "Meet someone new",
            "Take a photo at the photo booth",
            "Request a song",
            "Give a toast (or record one)",
            "Find someone from out of state",
            "Catch the bouquet/garter",
            "Share a wedding tip",
            "Post in the event feed",
            "Upload 3 photos",
            "Play all the games",
            "Find your table assignment"
        ];

        window.startBingo = () => {
            const container = document.getElementById('bingo-grid');
            const shuffled = [...bingoItems].sort(() => Math.random() - 0.5).slice(0, 9);
            
            container.innerHTML = shuffled.map((item, i) => `
                <button onclick="toggleBingo(${i})" 
                        class="bingo-cell p-3 border-2 border-stone-300 rounded-lg text-xs hover:bg-emerald-50 transition"
                        data-index="${i}">
                    ${item}
                </button>
            `).join('');
        }

        window.toggleBingo = (index) => {
            const cell = document.querySelector(`[data-index="${index}"]`);
            cell.classList.toggle('bg-emerald-200');
            cell.classList.toggle('border-emerald-500');
            
            const completed = document.querySelectorAll('.bingo-cell.bg-emerald-200').length;
            if (completed === 9) {
                showToast("BINGO! You completed all challenges! 🎉");
                updateUserPoints(100, 'social_butterfly');
                setTimeout(() => closeModal('bingo-modal'), 2000);
            }
        }

        // Scavenger Hunt
        const scavengerItems = [
            { location: "Wedding Ceremony Site", task: "Take a photo where J&E will say 'I do'", points: 20 },
            { location: "Beach at Sunset", task: "Capture the perfect sunset photo", points: 15 },
            { location: "Broadway at the Beach", task: "Ride the SkyWheel", points: 25 },
            { location: "Local Mini Golf", task: "Get a hole-in-one (or try!)", points: 20 },
            { location: "Barefoot Landing", task: "Feed the fish at the pond", points: 15 },
            { location: "2nd Avenue Pier", task: "Take a pic at the end of the pier", points: 20 }
        ];

        window.startScavengerHunt = () => {
            const container = document.getElementById('scavenger-list');
            
            container.innerHTML = scavengerItems.map((item, i) => `
                <div class="scavenger-item p-4 border rounded-lg" data-index="${i}">
                    <div class="flex items-start justify-between">
                        <div>
                            <h4 class="font-bold">${item.location}</h4>
                            <p class="text-sm text-stone-600">${item.task}</p>
                            <p class="text-xs text-emerald-600 mt-1">+${item.points} points</p>
                        </div>
                        <button onclick="completeScavengerItem(${i})" 
                                class="ml-4 px-3 py-1 bg-emerald-600 text-white rounded-lg text-sm">
                            Complete
                        </button>
                    </div>
                </div>
            `).join('');
        }

        window.completeScavengerItem = async (index) => {
            const item = scavengerItems[index];
            const element = document.querySelector(`[data-index="${index}"]`);
            
            element.classList.add('completed', 'bg-emerald-50');
            element.querySelector('button').disabled = true;
            element.querySelector('button').textContent = '✓ Done';
            
            await updateUserPoints(item.points);
            showToast(`+${item.points} points for ${item.location}!`);
            
            const completed = document.querySelectorAll('.scavenger-item.completed').length;
            if (completed === scavengerItems.length) {
                showToast("Scavenger hunt complete! Bonus +50 points! 🎉");
                await updateUserPoints(50);
            }
        }

        // Predictions
        const predictionPrompts = [
            { q: "How many kids will J&E have?", type: "number", id: "kids" },
            { q: "Where will they go for their 10th anniversary?", type: "text", id: "anniversary" },
            { q: "What pet will they get first?", type: "select", options: ["Dog", "Cat", "Fish", "Bird", "No pets"], id: "pet" },
            { q: "What hobby will they take up together?", type: "text", id: "hobby" },
            { q: "What will be their song in 10 years?", type: "text", id: "song" }
        ];

        window.startPredictions = () => {
            const container = document.getElementById('predictions-form');
            
            container.innerHTML = predictionPrompts.map(prompt => {
                let inputHTML = '';
                
                switch(prompt.type) {
                    case 'number':
                        inputHTML = `<input type="number" id="pred-${prompt.id}" min="0" max="10" class="rsvp-input" required>`;
                        break;
                    case 'select':
                        inputHTML = `
                            <select id="pred-${prompt.id}" class="rsvp-input" required>
                                <option value="">Choose...</option>
                                ${prompt.options.map(opt => `<option value="${opt}">${opt}</option>`).join('')}
                            </select>
                        `;
                        break;
                    default:
                        inputHTML = `<input type="text" id="pred-${prompt.id}" class="rsvp-input" required>`;
                }
                
                return `
                    <div>
                        <label class="block text-sm font-medium mb-2">${prompt.q}</label>
                        ${inputHTML}
                    </div>
                `;
            }).join('');
        }

        document.getElementById('submit-predictions').addEventListener('click', async () => {
            const predictions = {};
            let allFilled = true;
            
            predictionPrompts.forEach(prompt => {
                const value = document.getElementById(`pred-${prompt.id}`).value;
                if (!value) allFilled = false;
                predictions[prompt.id] = value;
            });
            
            if (!allFilled) {
                showToast("Please answer all questions", "error");
                return;
            }
            
            try {
                await addDoc(collection(db, `artifacts/${appId}/public/data/predictions`), {
                    userId: currentUser.uid,
                    userName: currentUser.displayName,
                    predictions: predictions,
                    timestamp: serverTimestamp()
                });
                
                await updateUserPoints(30, 'love_prophet');
                showToast("Predictions saved! +30 points");
                closeModal('predictions-modal');
            } catch (error) {
                console.error("Error saving predictions:", error);
                showToast("Failed to save predictions", "error");
            }
        });

        // Utilities
        function formatRelativeTime(date) {
            const now = new Date();
            const diff = now - date;
            const minutes = Math.floor(diff / 60000);
            const hours = Math.floor(diff / 3600000);
            const days = Math.floor(diff / 86400000);
            
            if (minutes < 1) return 'Just now';
            if (minutes < 60) return `${minutes}m ago`;
            if (hours < 24) return `${hours}h ago`;
            if (days < 7) return `${days}d ago`;
            
            return date.toLocaleDateString();
        }

        // More menu toggle
        window.toggleMoreMenu = () => {
            const menu = document.getElementById('more-menu');
            menu.classList.toggle('hidden');
        }

        // Click outside to close more menu
        document.addEventListener('click', (e) => {
            const menu = document.getElementById('more-menu');
            const moreButton = e.target.closest('.nav-icon:last-child');
            
            if (!menu.contains(e.target) && !moreButton) {
                menu.classList.add('hidden');
            }
        });

        // Dark mode toggle
        const darkModeToggle = document.getElementById('dark-mode-toggle');
        const htmlEl = document.documentElement;
        
        function applyTheme(theme) {
            if (theme === 'dark') {
                htmlEl.classList.add('dark');
            } else {
                htmlEl.classList.remove('dark');
            }
            localStorage.setItem('wedding-theme', theme);
        }
        
        darkModeToggle.addEventListener('click', () => {
            const currentTheme = htmlEl.classList.contains('dark') ? 'dark' : 'light';
            const newTheme = currentTheme === 'dark' ? 'light' : 'dark';
            applyTheme(newTheme);
        });
        
        // Apply saved theme or default to system preference
        const savedTheme = localStorage.getItem('wedding-theme');
        if (savedTheme) {
            applyTheme(savedTheme);
        } else if (window.matchMedia('(prefers-color-scheme: dark)').matches) {
            applyTheme('dark');
        }

        // Service worker registration
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('service-worker.js')
                    .then(reg => console.log('Service Worker registered'))
                    .catch(err => console.log('Service Worker registration failed'));
            });
        }

        // Initialize app
        initialize();

        // Keyboard shortcuts
        document.addEventListener('keydown', (e) => {
            if (e.ctrlKey || e.metaKey) {
                switch(e.key) {
                    case '1': showPage('home'); break;
                    case '2': showPage('schedule'); break;
                    case '3': showPage('photos'); break;
                    case '4': showPage('games'); break;
                    case '5': showPage('guestbook'); break;
                }
            }
        });

        // Add to window for onclick handlers
        window.showToast = showToast;
        window.likePost = likePost;
        window.filterSchedule = filterSchedule;
        window.getDirections = getDirections;
        window.openLightbox = openLightbox;
        window.closeLightbox = closeLightbox;
        window.previousPhoto = previousPhoto;
        window.nextPhoto = nextPhoto;
        window.filterPhotos = filterPhotos;
        window.setPhotoFilter = setPhotoFilter;
        window.capturePhoto = capturePhoto;
        window.saveBoothPhoto = saveBoothPhoto;
        window.filterGuestbook = filterGuestbook;
        window.openGuestbookModal = openGuestbookModal;
        window.shareHighlight = shareHighlight;
        window.filterGuide = filterGuide;
        window.setAttending = setAttending;
        window.requestSong = requestSong;
        window.voteSong = voteSong;
        window.checkAnswer = checkAnswer;
        window.toggleBingo = toggleBingo;
        window.completeScavengerItem = completeScavengerItem;
        window.toggleMoreMenu = toggleMoreMenu;
    </script>
</body>
</html>
